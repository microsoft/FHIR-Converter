{% comment -%}
The following reference IDs are accepted by this template.

Practitioner_ID_OBX_16: A resource Id, used to fill "performer.reference" property. The resource is of "Practitioner" type and generated based on "OBX.16" HL7 V2 identifier.
Organization_ID_OBX_23: A resource Id, used to fill "performer.reference" property. The resource is of "Organization" type and generated based on "OBX.23" HL7 V2 identifier.
PractitionerRole_ID_OBX_25: A resource Id, used to fill "performer.reference" property. The resource is of "PractitionerRole" type and generated based on "OBX.25" HL7 V2 identifier.
Observation_Subject_ID: A resource Id, used to fill "subject.reference" property.
Observation_Encounter_ID: A resource Id, used to fill "encounter.reference" property.
Observation_Specimen_ID: A resource Id, used to fill "specimen.reference" property.
{% endcomment -%}

{% evaluate Practitioner_ID_OBX_16 using 'ID/Practitioner' XCN: OBX.16 -%}
{% evaluate Organization_ID_OBX_23 using 'ID/Organization' XON: OBX.23 -%}
{% evaluate PractitionerRole_ID_OBX_25 using 'ID/PractitionerRole' XCN: OBX.25 -%}

{
    "fullUrl":"urn:uuid:{{ ID }}",
    "resource":{
        "resourceType": "Observation",
        "id":"{{ ID }}",
        "code":
        {
            {% include 'DataType/CWECodeableConcept' CWE: OBX.3 -%}
        },
        "valueQuantity":
        {
            {% if OBX.2.Value == "NM" -%}
                "value":"{{ OBX.5.Value }}",
            {% endif -%}
            {% comment -%} Placeholder provided for customization by users. If left empty, it will be removed in post-processing. {% endcomment -%}
            {% if OBX.2.Value == "SN" -%}
            {% endif -%}
            {% if OBX.2.Value == "SN" -%}
                {% include 'DataType/CWEQuantity' CWE: OBX.6 -%}
            {% endif -%}
            {% if OBX.2.Value == "NA" or OBX.2.Value == "NM" -%}
                {% include 'DataType/CWEQuantity' CWE: OBX.6 -%}
            {% endif -%}
        },
        {% if OBX.2.Value == "ST" or OBX.2.Value == "FT" or OBX.2.Value == "TX" -%}
            "valueString":"{{ OBX.5.Value }}",
        {% endif -%}
        {% if OBX.2.Value == "VR" -%}
            "valueString":"{{ OBX.5.1 }}-{{ OBX.5.2 }}",
        {% endif -%}
        {% if OBX.2.Value == "SN" -%}
            "valueString":"{{ OBX.5.1 }} {{ OBX.5.2 }} {{ OBX.5.3 }}",
        {% endif -%}
        "valueCodeableConcept":
        {
            {% if OBX.2.Value == "CF" or OBX.2.Value == "CNE" or OBX.2.Value == "CWE" or OBX.2.Value == "CE" -%}
                {% include 'DataType/CWECodeableConcept' CWE: OBX.5 -%}
            {% endif -%}
            {% comment -%} Placeholder provided for customization by users. If left empty, it will be removed in post-processing. {% endcomment -%}
            {% if OBX.2.Value == "IS" -%}
            {% endif -%}
        },
        "valuePeriod":
        {
            {% if OBX.2.Value == "DR" -%}
                {% include 'DataType/DR' DR: OBX.5 -%}
            {% endif -%}
        },
        {% if OBX.2.Value == "DTM" or OBX.2.Value == "DT" -%}
            "valueDateTime":"{{ OBX.5.Value | format_as_date_time }}",
        {% endif -%}
        {% if OBX.2.Value == "TM" -%}
            "valueTime":"{{ OBX.5.Value }}",
        {% endif -%}
        "valueRatio":
        {
            {% if OBX.2.Value == "SN" -%}{% if OBX.5.3.Value == ":" or OBX.5.3.Value == "/" -%}
                {% include 'DataType/SNRatio' SN: OBX.5 -%}
            {% endif -%}{% endif -%}
            "numerator":
            {
                {% if OBX.2.Value == "SN" -%}{% if OBX.5.3.Value == ":" or OBX.5.3.Value == "/" -%}
                    {% include 'DataType/CWEQuantity' CWE: OBX.6 -%}
                {% endif -%}{% endif -%}
            },
            "denominator":
            {
                {% if OBX.2.Value == "SN" -%}{% if OBX.5.3.Value == ":" or OBX.5.3.Value == "/" -%}
                    {% include 'DataType/CWEQuantity' CWE: OBX.6 -%}
                {% endif -%}{% endif -%}
            },
        },
        "interpretation":
        [
            {
                {% include 'DataType/CWECodeableConcept' mapping: 'CodeSystem/InterpretationCode', CWE: OBX.8 -%}
            },
        ],
        "status":"{{ OBX.11.Value | get_property: 'CodeSystem/ObservationStatus', 'code' }}",
        "effectiveDateTime":"{{ OBX.14.Value | format_as_date_time }}",
        {% comment -%} Placeholder provided for customization by users. If left empty, it will be removed in post-processing. {% endcomment -%}
        "method":
        {
        },
        "bodySite":
        {
            {% include 'DataType/CWECodeableConcept' CWE: OBX.20 -%}
        },
        "identifier":
        [
            {
                {% include 'DataType/EIIdentifier' EI: OBX.21 -%}
            },
            {
                "type":
                {
                    "coding":
                    [
                        {
                            {% if OBX.21 -%}
                                "code":"FILL",
                            {% endif -%}
                        },
                    ],
                },
            },
        ],
        "performer":
        [
            {
                {% if OBX.16 and Practitioner_ID_OBX_16 -%}
                    "reference":"Practitioner/{{ Practitioner_ID_OBX_16 }}",
                {% endif -%}
            },
            {
                {% if OBX.23 and Organization_ID_OBX_23 -%}
                    "reference":"Organization/{{ Organization_ID_OBX_23 }}",
                {% endif -%}
            },
            {
                {% if OBX.25 and PractitionerRole_ID_OBX_25 -%}
                    "reference":"PractitionerRole/{{ PractitionerRole_ID_OBX_25 }}",
                {% endif -%}
            },
        ],
        "component":
        [
            {
                "code":
                {
                    {% include 'DataType/CWECodeableConcept' CWE: OBX.3 -%}
                },
                "valueQuantity":
                {
                    {% if OBX.2.Value == "NM" -%}
                        "value":"{{ OBX.5.Value }}",
                    {% endif -%}
                    {% comment -%} Placeholder provided for customization by users. If left empty, it will be removed in post-processing. {% endcomment -%}
                    {% if OBX.2.Value == "SN" -%}
                    {% endif -%}
                    {% if OBX.2.Value == "SN" -%}
                        {% include 'DataType/CWEQuantity' CWE: OBX.6 -%}
                    {% endif -%}
                    {% if OBX.2.Value == "NA" or OBX.2.Value == "NM" -%}
                        {% include 'DataType/CWEQuantity' CWE: OBX.6 -%}
                    {% endif -%}
                },
                {% if OBX.2.Value == "ST" or OBX.2.Value == "FT" or OBX.2.Value == "TX" -%}
                    "valueString":"{{ OBX.5.Value }}",
                {% endif -%}
                {% if OBX.2.Value == "VR" -%}
                    "valueString":"{{ OBX.5.1 }}-{{ OBX.5.2}}",
                {% endif -%}
                {% if OBX.2.Value == "SN" -%}
                    "valueString":"{{ OBX.5.1 }} {{ OBX.5.2 }} {{ OBX.5.3 }}",
                {% endif -%}
                "valueCodeableConcept":
                {
                    {% comment -%} Placeholder provided for customization by users. If left empty, it will be removed in post-processing. {% endcomment -%}
                    {% if OBX.2.Value == "CF" or OBX.2.Value == "CNE" or OBX.2.Value == "CWE" or OBX.2.Value == "CE" -%}
                    {% endif -%}
                    {% comment -%} Placeholder provided for customization by users. If left empty, it will be removed in post-processing. {% endcomment -%}
                    {% if OBX.2.Value == "IS" -%}
                    {% endif -%}
                },
                "valuePeriod":
                {
                    {% if OBX.2.Value == "DR" -%}
                        {% include 'DataType/DR' DR: OBX.5 -%}
                    {% endif -%}
                },
                {% if OBX.2.Value == "DTM" or OBX.2.Value == "DT" -%}
                    "valueDateTime":"{{ OBX.5.Value | format_as_date_time }}",
                {% endif -%}
                {% if OBX.2.Value == "TM" -%}
                    "valueTime":"{{ OBX.5.Value }}",
                {% endif -%}
                "valueRatio":
                {
                    {% if OBX.2.Value == "SN" -%}{% if OBX.5.3.Value == ":" or OBX.5.3.Value == "/" -%}
                        {% include 'DataType/SNRatio' SN: OBX.5 -%}
                    {% endif -%}{% endif -%}
                    "numerator":
                    {
                        {% if OBX.2.Value == "SN" -%}{% if OBX.5.3.Value == ":" or OBX.5.3.Value == "/" -%}
                            {% include 'DataType/CWEQuantity' CWE: OBX.6 -%}
                        {% endif -%}{% endif -%}
                    },
                    "denominator":
                    {
                        {% if OBX.2.Value == "SN" -%}{% if OBX.5.3.Value == ":" or OBX.5.3.Value == "/" -%}
                            {% include 'DataType/CWEQuantity' CWE: OBX.6 -%}
                        {% endif -%}{% endif -%}
                    },
                },
                "referenceRange":
                [
                    {
                        "text":"{{ OBX.7.Value }}",
                    },
                ],
                "interpretation":
                [
                    {
                        {% include 'DataType/CWECodeableConcept' mapping: 'CodeSystem/InterpretationCode', CWE: OBX.8 -%}
                    },
                ],
            },
        ],
        "subject":
        {
            "reference":"{{ Observation_Subject_ID }}",
        },
        "encounter":
        {
            "reference":"{{ Observation_Encounter_ID }}",
        },
        "specimen":
        {
            "reference":"{{ Observation_Specimen_ID }}",
        },
    },
    "request":{
        "method":"PUT",
        "url":"Observation/{{ ID }}",
    },
},
