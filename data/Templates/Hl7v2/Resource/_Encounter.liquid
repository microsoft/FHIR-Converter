{% comment -%}
The following reference IDs are accepted by this template.

Location_ID_PV1_3: A resource Id, used to fill "location.location.reference" property. The resource is of "Location" type and generated based on "PV1.3" HL7 V2 identifier.
Location_ID_PV1_6: A resource Id, used to fill "location.location.reference" property. The resource is of "Location" type and generated based on "PV1.6" HL7 V2 identifier.
Location_ID_PV1_37: A resource Id, used to fill "hospitalization.destination.reference" property. The resource is of "Location" type and generated based on "PV1.37" HL7 V2 identifier.
Encounter_Hospitalization_Origin_ID: A resource Id, used to fill "hospitalization.origin.reference" property.
Practitioner_ID_PV1_7: A resource Id, used to fill "participant.individual.reference" property. The resource is of "Practitioner" type and generated based on "PV1.7" HL7 V2 identifier.
Practitioner_ID_PV1_8: A resource Id, used to fill "participant.individual.reference" property. The resource is of "Practitioner" type and generated based on "PV1.8" HL7 V2 identifier.
Practitioner_ID_PV1_9: A resource Id, used to fill "participant.individual.reference" property. The resource is of "Practitioner" type and generated based on "PV1.9" HL7 V2 identifier.
Practitioner_ID_PV1_17: A resource Id, used to fill "participant.individual.reference" property. The resource is of "Practitioner" type and generated based on "PV1.17" HL7 V2 identifier.
Practitioner_ID_PV1_52: A resource Id, used to fill "participant.individual.reference" property. The resource is of "Practitioner" type and generated based on "PV1.52" HL7 V2 identifier.
{% endcomment -%}

{% evaluate Location_ID_PV1_3_1 using 'ID/Location' PL: PV1.3.1 -%}
{% evaluate Location_ID_PV1_3_2 using 'ID/Location' PL: PV1.3.2 -%}
{% evaluate Location_ID_PV1_3_3 using 'ID/Location' PL: PV1.3.3 -%}
{% evaluate Location_ID_PV1_3_4 using 'ID/Location' PL: PV1.3.4 -%}
{% evaluate Location_ID_PV1_3_7 using 'ID/Location' PL: PV1.3.7 -%}
{% evaluate Location_ID_PV1_3_8 using 'ID/Location' PL: PV1.3.8 -%}

{% evaluate Location_ID_PV1_6_1 using 'ID/Location' PL: PV1.6.1 -%}
{% evaluate Location_ID_PV1_6_2 using 'ID/Location' PL: PV1.6.2 -%}
{% evaluate Location_ID_PV1_6_3 using 'ID/Location' PL: PV1.6.3 -%}
{% evaluate Location_ID_PV1_6_4 using 'ID/Location' PL: PV1.6.4 -%}
{% evaluate Location_ID_PV1_6_7 using 'ID/Location' PL: PV1.6.7 -%}
{% evaluate Location_ID_PV1_6_8 using 'ID/Location' PL: PV1.6.8 -%}

{% evaluate Location_ID_PV1_42_1 using 'ID/Location' PL: PV1.42.1 -%}
{% evaluate Location_ID_PV1_42_2 using 'ID/Location' PL: PV1.42.2 -%}
{% evaluate Location_ID_PV1_42_3 using 'ID/Location' PL: PV1.42.3 -%}
{% evaluate Location_ID_PV1_42_4 using 'ID/Location' PL: PV1.42.4 -%}
{% evaluate Location_ID_PV1_42_7 using 'ID/Location' PL: PV1.42.7 -%}
{% evaluate Location_ID_PV1_42_8 using 'ID/Location' PL: PV1.42.8 -%}

{% evaluate Location_ID_PV1_43_1 using 'ID/Location' PL: PV1.43.1 -%}
{% evaluate Location_ID_PV1_43_2 using 'ID/Location' PL: PV1.43.2 -%}
{% evaluate Location_ID_PV1_43_3 using 'ID/Location' PL: PV1.43.3 -%}
{% evaluate Location_ID_PV1_43_4 using 'ID/Location' PL: PV1.43.4 -%}
{% evaluate Location_ID_PV1_43_7 using 'ID/Location' PL: PV1.43.7 -%}
{% evaluate Location_ID_PV1_43_8 using 'ID/Location' PL: PV1.43.8 -%}

{% evaluate Location_ID_PV2_1_1 using 'ID/Location' PL: PV2.1.1 -%}
{% evaluate Location_ID_PV2_1_2 using 'ID/Location' PL: PV2.1.2 -%}
{% evaluate Location_ID_PV2_1_3 using 'ID/Location' PL: PV2.1.3 -%}
{% evaluate Location_ID_PV2_1_4 using 'ID/Location' PL: PV2.1.4 -%}
{% evaluate Location_ID_PV2_1_7 using 'ID/Location' PL: PV2.1.7 -%}
{% evaluate Location_ID_PV2_1_8 using 'ID/Location' PL: PV2.1.8 -%}

{% evaluate Location_ID_PV1_37 using 'ID/Location' DLD: PV1.37 -%}

{% evaluate Practitioner_ID_PV1_7 using 'ID/Practitioner' XCN: PV1.7 -%}
{% evaluate Practitioner_ID_PV1_8 using 'ID/Practitioner' XCN: PV1.8 -%}
{% evaluate Practitioner_ID_PV1_9 using 'ID/Practitioner' XCN: PV1.9 -%}
{% evaluate Practitioner_ID_PV1_17 using 'ID/Practitioner' XCN: PV1.17 -%}
{% evaluate Practitioner_ID_PV1_52 using 'ID/Practitioner' XCN: PV1.52 -%}
{% evaluate Practitioner_ID_PV2_13 using 'ID/Practitioner' XCN: PV2.13 -%}

{% evaluate EpisodeOfCare_ID_PV1_54 using 'ID/EpisodeOfCare' PV1: PV1.54 -%}

{
    "fullUrl":"urn:uuid:{{ ID }}",
    "resource":{
        "resourceType": "Encounter",
        "id":"{{ ID }}",
        "class":
        {
            {% include 'DataType/CWECoding' mapping: 'CodeSystem/EncounterClass', CWE: PV1.2 -%}
        },
        {% if PV1.45 == null -%}
            "status": "{{ PV1.2.Value | get_property: 'CodeSystem/EncounterStatus', 'code' }}",
        {% endif -%}
        {% if PV1.45 -%}
            "status":"finished",
        {% endif -%}
        "location":
        [
            {
                {% if PV1.2.1.Value != "P" and Location_ID_PV1_3_1 -%}
                    "status":"active",
                {% endif -%}
                {% if PV1.2.1.Value == "P" and Location_ID_PV1_3_1 -%}
                    "status":"planned",
                {% endif -%}
                "location":
                {
                    {% if PV1.3.1 and Location_ID_PV1_3_1 -%}
                        "reference":"Location/{{ Location_ID_PV1_3_1 }}",
                    {% endif -%}
                },
            },
            {
                {% if PV1.2.1.Value != "P" and Location_ID_PV1_3_2 -%}
                    "status":"active",
                {% endif -%}
                {% if PV1.2.1.Value == "P" and Location_ID_PV1_3_2 -%}
                    "status":"planned",
                {% endif -%}
                "location":
                {
                    {% if PV1.3.3 and Location_ID_PV1_3_2 -%}
                        "reference":"Location/{{ Location_ID_PV1_3_2 }}",
                    {% endif -%}
                },
            },
            {
                {% if PV1.2.1.Value != "P" and Location_ID_PV1_3_3 -%}
                    "status":"active",
                {% endif -%}
                {% if PV1.2.1.Value == "P" and Location_ID_PV1_3_3 -%}
                    "status":"planned",
                {% endif -%}
                "location":
                {
                    {% if PV1.3.3 and Location_ID_PV1_3_3 -%}
                        "reference":"Location/{{ Location_ID_PV1_3_3 }}",
                    {% endif -%}
                },
            },
            {
                {% if PV1.2.1.Value != "P" and Location_ID_PV1_3_4 -%}
                    "status":"active",
                {% endif -%}
                {% if PV1.2.1.Value == "P" and Location_ID_PV1_3_4 -%}
                    "status":"planned",
                {% endif -%}
                "location":
                {
                    {% if PV1.3.3 and Location_ID_PV1_3_4 -%}
                        "reference":"Location/{{ Location_ID_PV1_3_4 }}",
                    {% endif -%}
                },
            },
            {
                {% if PV1.2.1.Value != "P" and Location_ID_PV1_3_7 -%}
                    "status":"active",
                {% endif -%}
                {% if PV1.2.1.Value == "P" and Location_ID_PV1_3_7 -%}
                    "status":"planned",
                {% endif -%}
                "location":
                {
                    {% if PV1.3.3 and Location_ID_PV1_3_7 -%}
                        "reference":"Location/{{ Location_ID_PV1_3_7 }}",
                    {% endif -%}
                },
            },
            {
                {% if PV1.2.1.Value != "P" and Location_ID_PV1_3_8 -%}
                    "status":"active",
                {% endif -%}
                {% if PV1.2.1.Value == "P" and Location_ID_PV1_3_8 -%}
                    "status":"planned",
                {% endif -%}
                "location":
                {
                    {% if PV1.3.3 and Location_ID_PV1_3_8 -%}
                        "reference":"Location/{{ Location_ID_PV1_3_8 }}",
                    {% endif -%}
                },
            },

            {
                {% if PV1.6.1 and Location_ID_PV1_6_1 -%}
                    "status":"completed",
                    "location":
                    {
            
                        "reference":"Location/{{ Location_ID_PV1_6_1 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'false' -%}
                {% endif -%}
            },
            {
                {% if PV1.6.2 and Location_ID_PV1_6_2 -%}
                    "status":"completed",
                    "location":
                    {
                            "reference":"Location/{{ Location_ID_PV1_6_2 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'false' -%}
                {% endif -%}
            },
            {
                {% if PV1.6.3 and Location_ID_PV1_6_3 -%}
                    "status":"completed",
                    "location":
                    {
                        "reference":"Location/{{ Location_ID_PV1_6_3 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'false' -%}
                {% endif -%}
            },
            {
                {% if PV1.6.4 and Location_ID_PV1_6_4 -%}
                    "status":"completed",
                    "location":
                    {
                        "reference":"Location/{{ Location_ID_PV1_6_4 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'false' -%}
                {% endif -%}
            },
            {
                {% if PV1.6.7 and Location_ID_PV1_6_7 -%}
                    "status":"completed",
                    "location":
                    {
                        "reference":"Location/{{ Location_ID_PV1_6_7 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'false' -%}
                {% endif -%}
            },
            {
                {% if PV1.6.8 and Location_ID_PV1_6_8 -%}
                    "status":"completed",
                    "location":
                    {
                        "reference":"Location/{{ Location_ID_PV1_6_8 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'false' -%}
                {% endif -%}
            },

            {
                {% if PV1.42.1 and Location_ID_PV1_42_1 -%}
                    "status":"planned",
                    "location":
                    {
                            "reference":"Location/{{ Location_ID_PV1_42_1 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'false' -%}
                {% endif -%}
            },
            {
                {% if PV1.42.2 and Location_ID_PV1_42_2 -%}
                    "status":"planned",
                    "location":
                    {
                            "reference":"Location/{{ Location_ID_PV1_42_2 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'false' -%}
                {% endif -%}
            },
            {
                {% if PV1.42.3 and Location_ID_PV1_42_3 -%}
                    "status":"planned",
                    "location":
                    {
                            "reference":"Location/{{ Location_ID_PV1_42_3 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'false' -%}
                {% endif -%}
            },
            {
                {% if PV1.42.4 and Location_ID_PV1_42_4 -%}
                    "status":"planned",
                    "location":
                    {
                            "reference":"Location/{{ Location_ID_PV1_42_4 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'false' -%}
                {% endif -%}
            },
            {
                {% if PV1.42.7 and Location_ID_PV1_42_7 -%}
                    "status":"planned",
                    "location":
                    {
                            "reference":"Location/{{ Location_ID_PV1_42_7 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'false' -%}
                {% endif -%}
            },
            {
                {% if PV1.42.8 and Location_ID_PV1_42_8 -%}
                    "status":"planned",
                    "location":
                    {
                            "reference":"Location/{{ Location_ID_PV1_42_8 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'false' -%}
                {% endif -%}
            },

            {
                {% if PV1.43.1 and Location_ID_PV1_43_1 -%}
                    "status":"completed",
                    "location":
                    {
                        "reference":"Location/{{ Location_ID_PV1_43_1 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'true' -%}
                {% endif -%}
            },
            {
                {% if PV1.43.2 and Location_ID_PV1_43_2 -%}
                    "status":"completed",
                    "location":
                    {
                        "reference":"Location/{{ Location_ID_PV1_43_2 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'true' -%}
                {% endif -%}
            },
            {
                {% if PV1.43.3 and Location_ID_PV1_43_3 -%}
                    "status":"completed",
                    "location":
                    {
                        "reference":"Location/{{ Location_ID_PV1_43_3 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'true' -%}
                {% endif -%}
            },
            {
                {% if PV1.43.4 and Location_ID_PV1_43_4 -%}
                    "status":"completed",
                    "location":
                    {
                        "reference":"Location/{{ Location_ID_PV1_43_4 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'true' -%}
                {% endif -%}
            },
            {
                {% if PV1.43.7 and Location_ID_PV1_43_7 -%}
                    "status":"completed",
                    "location":
                    {
                        "reference":"Location/{{ Location_ID_PV1_43_7 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'true' -%}
                {% endif -%}
            },
            {
                {% if PV1.43.8 and Location_ID_PV1_43_8 -%}
                    "status":"completed",
                    "location":
                    {
                        "reference":"Location/{{ Location_ID_PV1_43_8 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'true' -%}
                {% endif -%}
            },
            
            {
                {% if PV2.1.1 and Location_ID_PV2_1_1 -%}
                    "status":"planned",
                    "location":
                    {
                        "reference":"Location/{{ Location_ID_PV2_1_1 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'false' -%}
                {% endif -%}
            },
            {
                {% if PV2.1.2 and Location_ID_PV2_1_2 -%}
                    "status":"planned",
                    "location":
                    {
                        "reference":"Location/{{ Location_ID_PV2_1_2 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'false' -%}
                {% endif -%}
            },
            {
                {% if PV2.1.3 and Location_ID_PV2_1_3 -%}
                    "status":"planned",
                    "location":
                    {
                        "reference":"Location/{{ Location_ID_PV2_1_3 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'false' -%}
                {% endif -%}
            },
            {
                {% if PV2.1.4 and Location_ID_PV2_1_4 -%}
                    "status":"planned",
                    "location":
                    {
                        "reference":"Location/{{ Location_ID_PV2_1_4 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'false' -%}
                {% endif -%}
            },
            {
                {% if PV2.1.7 and Location_ID_PV2_1_7 -%}
                    "status":"planned",
                    "location":
                    {
                        "reference":"Location/{{ Location_ID_PV2_1_7 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'false' -%}
                {% endif -%}
            },
            {
                {% if PV2.1.8 and Location_ID_PV2_1_8 -%}
                    "status":"planned",
                    "location":
                    {
                        "reference":"Location/{{ Location_ID_PV2_1_8 }}",
                    },
                    {% include 'Extensions/TemporaryLocation' , status: 'false' -%}
                {% endif -%}
            }
        ],
        "type":
        [
            {
                {% include 'DataType/CWECodeableConcept' mapping: 'CodeSystem/AdmissionType', CWE: PV1.4 -%}
            },
        ],
        "hospitalization":
        {
            "preAdmissionIdentifier":
            {
                {% include 'DataType/CX' CX: PV1.5 -%}
            },
            "reAdmission":
            {
                {% include 'DataType/CWECodeableConcept' mapping: 'CodeSystem/ReadmissionIndicator', CWE: PV1.13 -%}
            },
            "admitSource":
            {
                {% include 'DataType/CWECodeableConcept' CWE: PV1.14 -%}
            },
            "dischargeDisposition":
            {
                {% include 'DataType/CWECodeableConcept' CWE: PV1.36 -%}
            },
            "dietPreference":
            [
                {
                    {% include 'DataType/CWECodeableConcept' CWE: PV1.38 -%}
                },
            ],
            "destination":
            {
                {% if PV1.37 and Location_ID_PV1_37 -%}
                    "reference":"Location/{{ Location_ID_PV1_37 }}",
                {% endif -%}
            },
            "origin":
            {
                "reference":"{{ Encounter_Hospitalization_Origin_ID }}",
            },
        },

        "episodeOfCare" : [
        { 
            {% if PV1.54 and EpisodeOfCare_ID_PV1_54 -%}
                "reference":"EpisodeOfCare/{{EpisodeOfCare_ID_PV1_54}}",
            {% endif -%}
        },
        ],

        "participant":
        [
            {
                "type":
                [
                    {
                        "coding":
                        [
                            {
                                {% if PV1.7 -%}
                                    "code":"ATND",
                                    "system":"http://terminology.hl7.org/CodeSystem/v3-ParticipationType",
                                    "display":"attender",
                                {% endif -%}
                            },
                        ],
                    },
                ],
                "individual":
                {
                    {% if PV1.7 and Practitioner_ID_PV1_7 -%}
                        "reference":"Practitioner/{{ Practitioner_ID_PV1_7 }}",
                    {% endif -%}
                },
            },
            {
                "type":
                [
                    {
                        "coding":
                        [
                            {
                                {% if PV1.8 -%}
                                    "code":"REF",
                                    "system":"http://terminology.hl7.org/CodeSystem/v3-ParticipationType",
                                {% endif -%}
                            },
                        ],
                        {% if PV1.8 -%}
                            "text":"referrer",
                        {% endif -%}
                    },
                ],
                "individual":
                {
                    {% if PV1.8 and Practitioner_ID_PV1_8 -%}
                        "reference":"Practitioner/{{ Practitioner_ID_PV1_8 }}",
                    {% endif -%}
                },
            },
            {
                "type":
                [
                    {
                        "coding":
                        [
                            {
                                {% if PV1.9 -%}
                                    "code":"CON",
                                    "system":"http://terminology.hl7.org/CodeSystem/v3-ParticipationType",
                                {% endif -%}
                            },
                        ],
                        {% if PV1.9 -%}
                            "text":"consultant",
                        {% endif -%}
                    },
                ],
                "individual":
                {
                    {% if PV1.9 and Practitioner_ID_PV1_9 -%}
                        "reference":"Practitioner/{{ Practitioner_ID_PV1_9 }}",
                    {% endif -%}
                },
            },
            {
                "type":
                [
                    {
                        "coding":
                        [
                            {
                                {% if PV1.17 -%}
                                    "code":"ADM",
                                    "system":"http://terminology.hl7.org/CodeSystem/v3-ParticipationType",
                                {% endif -%}
                            },
                        ],
                        {% if PV1.17 -%}
                            "text":"admitter",
                        {% endif -%}
                    },
                ],
                "individual":
                {
                    {% if PV1.17 and Practitioner_ID_PV1_17 -%}
                        "reference":"Practitioner/{{ Practitioner_ID_PV1_17 }}",
                    {% endif -%}
                },
            },
            {
                "type":
                [
                    {
                        "coding":
                        [
                            {
                                {% if PV1.52 -%}
                                    "code":"PART",
                                    "system":"http://terminology.hl7.org/CodeSystem/v3-ParticipationType",
                                {% endif -%}
                            },
                        ],
                        {% if PV1.52 -%}
                            "text":"Participation",
                        {% endif -%}
                    },
                ],
                "individual":
                {
                    {% if PV1.52 and Practitioner_ID_PV1_52 -%}
                        "reference":"Practitioner/{{ Practitioner_ID_PV1_52 }}",
                    {% endif -%}
                },
            },
            {
                "type":
                [
                    {   {% if PV2.13 -%}
                        "coding":
                        [
                            {
                                    "code":"REF",
                                    "system":"http://terminology.hl7.org/CodeSystem/v3-ParticipationType",
                            },
                        ],
                            "text":"referrer",
                        {% endif -%}
                    },
                ],
                "individual":
                {
                    {% if PV2.13 and Practitioner_ID_PV2_13 -%}
                        "reference":"Practitioner/{{ Practitioner_ID_PV2_13 }}",
                    {% endif -%}
                },
            },
        ],
        "serviceType":
        {
            {% include 'DataType/CWECodeableConcept' CWE: PV1.10 -%}
        },
        "identifier":
        [
            {
                {% if PV1.19 -%}
                    {% include 'DataType/CX' CX: PV1.19 -%}
                "type":
                {
                    "coding":
                    [
                        {
                                "code":"VN",
                                "system":"http://terminology.hl7.org/CodeSystem/v2-0203",
                        },
                    ],
                        "text":"visit number",
                },
                {% endif -%}
            },
            {% if PV1.50 -%}
                {% for p in PV1.50.Repeats -%}
                {
                    {% include 'DataType/CX' CX: p -%}
                },
                {% endfor -%}
            {% endif -%}

        ],
        "period":
        {
            "start":"{{ PV1.44.Value | format_as_date_time }}",
            "end":"{{ PV1.45.Value | format_as_date_time }}",
        },
        "reasonCode":
        [
            {
                {% if PV2.3 -%}
                    {% include 'DataType/CWECodeableConcept' CWE: PV2.3 -%}
                {% endif -%}
            },
        ],
        "length":
        {
            {% if PV2.11 -%}
             "value":{{ PV2.11.Value }},
             "unit":"d",
             "system":"http://unitsofmeasure.org/",
            {% endif -%}
        },
        "meta":{
            "security":[{
                {% include 'DataType/IDCoding' mapping: 'CodeSystem/EncounterSecurity', ID: PV2.22 -%}
            },
            ],
        },
        {% if Root_Template -%}
        {% assign generationInstant = "{{ "" | now }}" -%}
        {% assign templateVersion = "TEMPLATE_VERSION_PLACEHOLDER" -%}
        "text": {
            "status":"generated",
            "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\"><p><span>Visit Description: {{ PV2.12.Value }}</span></p></div>"
        },
        {% endif -%}
        "priority":
        {
            {% if PV2.25 -%}
                    {% include 'DataType/CWECodeableConcept' mapping: 'CodeSystem/EncounterPriority', CWE: PV2.25 -%}
            {% endif -%}
        },
        "diagnosis":
        [
            {% if conditionId %}
            {
                "condition" : { 
                    "reference":"Condition/{{ conditionId }}", 
                },
                "use" : { 
                    {% if DG1.6 -%}
                        {% include 'DataType/CWECodeableConcept' mapping: 'CodeSystem/DiagnosisType', CWE: DG1.6 -%}
                    {% endif -%}
                },
              
                {% assign temp = DG1.15.Value | sign %}
                {% if DG1.15 and temp != -1 %}
                    {% assign splitResult = DG1.15.Value | split: '.' %}
                    {% assign splitResultSize = splitResult | size %}
                    {% if splitResultSize == 1 %}
                        "rank": {{ DG1.15.Value }},
                    {% endif %}
                {% endif %}
            },
            {% endif %}
        ],
    },
    "request":{
        "method":"PUT",
        "url":"Encounter/{{ ID }}",
    },
},
