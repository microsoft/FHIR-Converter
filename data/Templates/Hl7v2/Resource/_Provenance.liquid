{% assign generationInstant = "{{ "" | now }}" -%}
{% assign templateVersion = "3.5.1" -%}
{% assign rootTemplate = Root_Template -%}
{% capture templateUrl -%}https://github.com/microsoft/FHIR-Converter/releases/download/v{{ templateVersion }}/Hl7v2DefaultTemplates.tar.gz{% endcapture -%}

{
    "fullUrl":"urn:uuid:{{ ID }}",
    "resource":{
        "resourceType": "Provenance",
        "id":"{{ ID }}",
        {% if Root_Template -%}
        "text": {
            "status": "generated",
            "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\"><p><span>Resource bundle generated on {{ generationInstant }} using Microsoft FHIR Converter.</span><span>Template Version: {{ templateVersion }}.</span><span>Template URL: {{ templateUrl }}.</span><span>Root template: {{ rootTemplate }}.</span></p><p>Disclaimer: Real world HL7 messages vary in richness and level of conformance with the spec. The output of converter depends on the templates as well as the quality and richness of input messages. Therefore, it is important that you review and validate the Converter output before using those in production.</p></div>"
        },
        {% endif -%}
        "agent":
        [
            {
                "type":
                {
                    "coding":
                    [
                        {
                            {% if MSH.21 == null -%}
                            "code":"author",
                            {% endif -%}
                            {% if MSH.22 -%}
                            "code":"author",
                            {% endif -%}
                            {% if ORC.10 -%}
                            "code":"enterer",
                            {% endif -%}
                            {% if MSH.21 == null -%}
                            "system":"http://terminology.hl7.org/CodeSystem/provenance-participant-type",
                            {% endif -%}
                            {% if MSH.22 -%}
                            "system":"http://terminology.hl7.org/CodeSystem/provenance-participant-type",
                            {% endif -%}
                            {% if ORC.10 -%}
                            "system":"http://terminology.hl7.org/CodeSystem/provenance-participant-type",
                            {% endif -%}
                        },
                    ],
                },
                "who":
                {
                    {% if MSH.4 and Organization_ID_MSH_4 -%}
                    "reference":"Organization/{{ Organization_ID_MSH_4 }}",
                    {% endif -%}
                    {% if MSH.22 and Organization_ID_MSH_22 -%}
                    "reference":"Organization/{{ Organization_ID_MSH_22 }}",
                    {% endif -%}
                    {% if ORC.10 and Practitioner_ID_ORC_10 -%}
                    "reference":"Practitioner/{{ Practitioner_ID_ORC_10 }}",
                    {% endif -%}
                },
                "onBehalfOf":
                {
                    {% if ORC.17 and Organization_ID_ORC_17 -%}
                    "reference":"Organization/{{ Organization_ID_ORC_17 }}",
                    {% endif -%}
                },
            },
            {
                "type":
                {
                    "coding":
                    [
                        {
                            {% if ORC.11 -%}
                            "code":"verifier",
                            {% endif -%}
                            {% if ORC.11 -%}
                            "system":"http://terminology.hl7.org/CodeSystem/provenance-participant-type",
                            {% endif -%}
                        },
                    ],
                },
                "who":
                {
                    {% if ORC.11 and Practitioner_ID_ORC_11 -%}
                    "reference":"Practitioner/{{ Practitioner_ID_ORC_11 }}",
                    {% endif -%}
                },
            },
            {
                "type":
                {
                    "coding":
                    [
                        {
                            {% if ORC.12 -%}
                            "code":"author",
                            {% endif -%}
                            {% if ORC.12 -%}
                            "system":"http://terminology.hl7.org/CodeSystem/provenance-participant-type",
                            {% endif -%}
                        },
                    ],
                },
                "who":
                {
                    {% if ORC.12 and Practitioner_ID_ORC_12 -%}
                    "reference":"Practitioner/{{ Practitioner_ID_ORC_12 }}",
                    {% endif -%}
                },
            },
        ],
        "recorded":"{{ MSH.7.Value | format_as_date_time }}",
        "recorded":"{{ ORC.9.Value | format_as_date_time }}",
        "activity":
        {
            "coding":
            [
                {
                    {% if ORC.1.Value == "NW" -%}
                    "code":"CREATE",
                    {% endif -%}
                    {% if ORC.1.Value == "SC" -%}
                    "code":"UPDATE",
                    {% endif -%}
                    {% if ORC.1.Value == "OC" or ORC.1.Value == "CA" -%}
                    "code":"DELETE",
                    {% endif -%}
                    {% if ORC.1.Value == "NW" -%}
                    "system":"http://terminology.hl7.org/CodeSystem/v3-DataOperation",
                    {% endif -%}
                    {% if ORC.1.Value == "SC" -%}
                    "system":"http://terminology.hl7.org/CodeSystem/v3-DataOperation",
                    {% endif -%}
                    {% if ORC.1.Value == "OC" or ORC.1.Value == "CA" -%}
                    "system":"http://terminology.hl7.org/CodeSystem/v3-DataOperation",
                    {% endif -%}
                },
            ],
        },
        "occurredDateTime":"{{ ORC.9.Value | format_as_date_time }}",
        "location":
        {
            {% if ORC.21 and Location_ID_ORC_21 -%}
            "reference":"Location/{{ Location_ID_ORC_21 }}",
            {% endif -%}
        },
    },
    "request":{
        "method":"PUT",
        "url":"Provenance/{{ ID }}",
    },
},
