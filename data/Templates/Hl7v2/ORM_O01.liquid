{% assign firstSegments = hl7v2Data | get_first_segments: 'MSH|PID|PD1|PV1|PV2' -%}

{% assign gt1SegmentLists = hl7v2Data | get_segment_lists: 'GT1' -%}
{% assign in1SegmentLists = hl7v2Data | get_segment_lists: 'IN1' -%}
{% assign al1SegmentLists = hl7v2Data | get_segment_lists: 'AL1' -%}
{% assign orcSegmentLists = hl7v2Data | get_segment_lists: 'ORC' -%}
{% assign obxSegmentLists = hl7v2Data | get_segment_lists: 'OBX' -%}
{% evaluate bundleID using 'ID/Bundle' Data: firstSegments.MSH.10 -%}                  
        
{
    "resourceType": "Bundle",
    "type": "batch",
    {% if firstSegments.MSH.7 -%}
        "timestamp":"{{ firstSegments.MSH.7.Value | format_as_date_time }}",
    {% endif -%}
    "identifier":
    {
        "value":"{{ firstSegments.MSH.10.Value }}",
    },
    "id":"{{ bundleID }}",
    "entry": [

        {% evaluate patientId using 'ID/Patient' PID: firstSegments.PID, type: 'First' -%}
        {% assign fullPatientId = patientId | prepend: 'Patient/' -%}
        {% evaluate messageHeaderId using 'ID/MessageHeader' MSH: firstSegments.MSH -%}
          
        {% if firstSegments.MSH -%}   

            {% include 'Resource/MessageHeader' MSH: firstSegments.MSH, ID: messageHeaderId -%}              
            {% evaluate provenanceId using 'ID/Provenance' MSH: firstSegments.MSH, baseId: patientId -%}
            {% include 'Resource/Provenance' Root_Template: 'ORM_O01', MSH: firstSegments.MSH, REF_BUNDLE: bundleID, ID: provenanceId -%}
            
            {% if firstSegments.MSH.4 -%}
                {% if firstSegments.MSH.4.1 != "" and firstSegments.MSH.4.1 != null or firstSegments.MSH.4.2 != "" and firstSegments.MSH.4.2 != null or firstSegments.MSH.4.3 != "" and firstSegments.MSH.4.3 != null -%}
                    {% evaluate organization_ID_MSH_4 using 'ID/Organization' HD: firstSegments.MSH.4 -%}
                    {% include 'Resource/Organization' MSHHD1: firstSegments.MSH.4, MSH: firstSegments.MSH, ID: organization_ID_MSH_4 -%}
                {% endif -%}
            {% endif -%}  

            {% if firstSegments.MSH.6 %}
                {% if firstSegments.MSH.6.1 != "" and firstSegments.MSH.6.1 != null or firstSegments.MSH.6.2 != "" and firstSegments.MSH.6.2 != null or firstSegments.MSH.6.3 != "" and firstSegments.MSH.6.3 != null -%}
                    {% evaluate organization_Id_MSH_6 using 'ID/Organization' HD: firstSegments.MSH.6 -%}
                    {% include 'Resource/Organization' MSHHD2: firstSegments.MSH.6, MSH: firstSegments.MSH, ID: organization_Id_MSH_6 -%}
                {% endif -%}
            {% endif -%}
            
            {% if firstSegments.MSH.22 %}
                {% if firstSegments.MSH.22.1 != "" and firstSegments.MSH.22.1 != null -%}  
                    {% evaluate organization_Id_MSH_22 using 'ID/Organization' XON: firstSegments.MSH.22 -%}
                    {% include 'Resource/Organization' MSHXON1: firstSegments.MSH.22, ID: organization_Id_MSH_22 -%}
                {% endif -%}
            {% endif -%}

            {% if firstSegments.MSH.23 %}
                {% if firstSegments.MSH.23.1 != "" and firstSegments.MSH.23.1 != null -%}
                    {% evaluate organization_Id_MSH_23 using 'ID/Organization' XON: firstSegments.MSH.23 -%}
                    {% include 'Resource/Organization' MSHXON2: firstSegments.MSH.23, ID: organization_Id_MSH_23 -%}
                {% endif -%}   
            {% endif -%}
            {% if firstSegments.MSH.3 and firstSegments.MSH.24 %}
                {% evaluate device_Id_MSH_3 using 'ID/Device' HD: firstSegments.MSH.3 -%}
                {% include 'Resource/Device' MSH: firstSegments.MSH, ID: device_Id_MSH_3 -%}
            {% endif -%}

        {% endif -%}
        
        {% include 'Resource/Patient' PID: firstSegments.PID, PD1: firstSegments.PD1, ID: patientId -%}
        {% include 'Extensions/Patient/PatientExtension' ID: PatientId, PID: firstSegments.PID, PD1: firstSegments.PD1, PV1: firstSegments.PV1 -%}
        
        {% if firstSegments.PID.18 -%}
            {% evaluate accountId using 'ID/Account' CX: firstSegments.PID.18, baseId: patientId -%}
            {% include 'Resource/Account' PID: firstSegments.PID, ID: accountId -%}
            {% include 'Reference/Account/Subject' ID: accountId, REF: fullPatientId -%}
            {% if firstSegments.PID.18.4.1 != "" and firstSegments.PID.18.4.1 != null and firstSegments.PID.18.4.2 != "" and firstSegments.PID.18.4.2 != null and firstSegments.PID.18.4.3 != "" and firstSegments.PID.18.4.3 != null -%}
                {% evaluate Organization_ID_pid_CX_18 using 'ID/Organization' HDORG: firstSegments.PID.18.4 -%}
                {% include 'Resource/Organization', PID: firstSegments.PID.18, ID: Organization_ID_pid_CX_18 -%}
            {% endif -%}
        {% endif -%}

        {% unless firstSegments.PID.18 %}
            {% evaluate accountId using 'ID/Account' GT1_Account: gt1SegmentLists.GT1[0], baseId: patientId -%}
        {% endunless -%}

        {% for gt1SegmentLists in gt1SegmentLists.GT1 -%}
            {% unless gt1SegmentLists.21 %}
                {% if gt1SegmentLists.11.1.Value == "SEL" -%}
                    {% include 'Resource/Patient' PID: firstSegments.PID, GT1: gt1SegmentLists, ID: patientId, NK1_PER: nk1SegmentLists.NK1[0], pda_seg: checkPDASeg -%}
                    {% if gt1SegmentLists.2.4.1 != "" and gt1SegmentLists.2.4.1 != null and gt1SegmentLists.2.4.2 != "" and gt1SegmentLists.2.4.2 != null and gt1SegmentLists.2.4.3 != "" and gt1SegmentLists.2.4.3 != null -%}
                        {% evaluate Organization_ID_gt1_CX_2 using 'ID/Organization' HDORG: gt1SegmentLists.2.4 -%}
                        {% include 'Resource/Organization', PID: gt1SegmentLists.2, ID: Organization_ID_gt1_CX_2 -%}
                    {% endif -%}
                    {% if gt1SegmentLists.19.4.1 != "" and gt1SegmentLists.19.4.1 != null and gt1SegmentLists.19.4.2 != "" and gt1SegmentLists.19.4.2 != null and gt1SegmentLists.19.4.3 != "" and gt1SegmentLists.19.4.3 != null -%}
                        {% evaluate Organization_ID_gt1_CX_19 using 'ID/Organization' HDORG: gt1SegmentLists.19.4 -%}
                        {% include 'Resource/Organization', PID: gt1SegmentLists.19, ID: Organization_ID_gt1_CX_19 -%}
                    {% endif -%}
                    {% if gt1SegmentLists.29.4.1 != "" and gt1SegmentLists.29.4.1 != null and gt1SegmentLists.29.4.2 != "" and gt1SegmentLists.29.4.2 != null and gt1SegmentLists.29.4.3 != "" and gt1SegmentLists.29.4.3 != null -%}
                        {% evaluate Organization_ID_gt1_CX_29 using 'ID/Organization' HDORG: gt1SegmentLists.29.4 -%}
                        {% include 'Resource/Organization', PID: gt1SegmentLists.29, ID: Organization_ID_gt1_CX_29 -%}
                    {% endif -%}
                    {% if gt1SegmentLists.51 -%}
                        {% evaluate Organization_ID_gt1_XON_51 using 'ID/Organization' XON: gt1SegmentLists.51 -%}
                        {% include 'Resource/Organization', GT1_51: gt1SegmentLists, ID: Organization_ID_gt1_XON_51 -%}
                        {% assign Organization_GT1_51 = Organization_ID_gt1_XON_51 | prepend: 'Organization/' -%}
                    {% endif -%}
                {% else -%}
                    {% evaluate gt1relatedPersonId using 'ID/RelatedPerson' GT1: gt1SegmentLists, baseId: patientId -%}
                    {% include 'Resource/RelatedPerson' RelatedPerson_Patient_ID: fullPatientId, ID: gt1relatedPersonId, GT1: gt1SegmentLists -%}
                    {% if gt1SegmentLists.2.4.1 != "" and gt1SegmentLists.2.4.1 != null and gt1SegmentLists.2.4.2 != "" and gt1SegmentLists.2.4.2 != null and gt1SegmentLists.2.4.3 != "" and gt1SegmentLists.2.4.3 != null -%}
                        {% evaluate Organization_ID_gt1_CX_2 using 'ID/Organization' HDORG: gt1SegmentLists.2.4 -%}
                        {% include 'Resource/Organization', PID: gt1SegmentLists.2, ID: Organization_ID_gt1_CX_2 -%}
                    {% endif -%}
                    {% if gt1SegmentLists.19.4.1 != "" and gt1SegmentLists.19.4.1 != null and gt1SegmentLists.19.4.2 != "" and gt1SegmentLists.19.4.2 != null and gt1SegmentLists.19.4.3 != "" and gt1SegmentLists.19.4.3 != null -%}
                        {% evaluate Organization_ID_gt1_CX_19 using 'ID/Organization' HDORG: gt1SegmentLists.19.4 -%}
                        {% include 'Resource/Organization', PID: gt1SegmentLists.19, ID: Organization_ID_gt1_CX_19 -%}
                    {% endif -%}
                {% endif -%}
            {% endunless -%}
            {% if gt1SegmentLists.21 -%}
                {% evaluate Organization_ID_gt1_XON_21 using 'ID/Organization' XON: gt1SegmentLists.21 -%}
                {% include 'Resource/Organization', GT1: gt1SegmentLists, ID: Organization_ID_gt1_XON_21 -%}
                {% if gt1SegmentLists.2.4.1 != "" and gt1SegmentLists.2.4.1 != null and gt1SegmentLists.2.4.2 != "" and gt1SegmentLists.2.4.2 != null and gt1SegmentLists.2.4.3 != "" and gt1SegmentLists.2.4.3 != null -%}
                    {% evaluate Organization_ID_gt1_CX_2 using 'ID/Organization' HDORG: gt1SegmentLists.2.4 -%}
                    {% include 'Resource/Organization', PID: gt1SegmentLists.2, ID: Organization_ID_gt1_CX_2 -%}
                {% endif -%}
            {% endif -%}
            {% include 'Resource/Account' GT1: gt1SegmentLists, ID: accountId, REF_PATIENT: fullPatientId, REF_RELATED_PERSON: gt1relatedPersonId, REF_ORG: Organization_ID_gt1_XON_21 -%}
            {% include 'Reference/Account/Subject' ID: accountId, REF: fullPatientId -%}
        {% endfor -%}

        {% if firstSegments.PID.2 -%}
            {% if firstSegments.PID.2.4.1 != "" and firstSegments.PID.2.4.1 != null and firstSegments.PID.2.4.2 != "" and firstSegments.PID.2.4.2 != null and firstSegments.PID.2.4.3 != "" and firstSegments.PID.2.4.3 != null -%}
                {% evaluate Organization_ID_pid_CX_2 using 'ID/Organization' HDORG: firstSegments.PID.2.4 -%}
                {% include 'Resource/Organization', PID: firstSegments.PID.2, ID: Organization_ID_pid_CX_2 -%}
            {% endif -%}
        {% endif -%}
        {% for pid3 in firstSegments.PID.3.Repeats -%}
            {% if pid3.4.1 != "" and pid3.4.1 != null and pid3.4.2 != "" and pid3.4.2 != null and pid3.4.3 != "" and pid3.4.3 != null -%}
                {% evaluate Organization_ID_pid_CX using 'ID/Organization' HDORG: pid3.4 -%}
                {% include 'Resource/Organization', PID: pid3, ID: Organization_ID_pid_CX -%}
            {% endif -%}
        {% endfor -%}
        {% if firstSegments.PID.4 -%}
            {% if firstSegments.PID.4.4.1 != "" and firstSegments.PID.4.4.1 != null and firstSegments.PID.4.4.2 != "" and firstSegments.PID.4.4.2 != null and firstSegments.PID.4.4.3 != "" and firstSegments.PID.4.4.3 != null -%}
                {% evaluate Organization_ID_pid_CX_4 using 'ID/Organization' HDORG: firstSegments.PID.4.4 -%}
                {% include 'Resource/Organization', PID: firstSegments.PID.4, ID: Organization_ID_pid_CX_4 -%}
            {% endif -%}
        {% endif -%}

        {% unless nk1SegmentLists.NK1 -%}
            {% if firstSegments.PID.21 -%}
            {% if firstSegments.PID.21.4.1 != "" and firstSegments.PID.21.4.1 != null and firstSegments.PID.21.4.2 != "" and firstSegments.PID.21.4.2 != null and firstSegments.PID.21.4.3 != "" and firstSegments.PID.21.4.3 != null -%}
                {% evaluate Organization_ID_pid_CX_21 using 'ID/Organization' HDORG: firstSegments.PID.21.4 -%}
                {% include 'Resource/Organization', PID: firstSegments.PID.21, ID: Organization_ID_pid_CX_21 -%}
            {% endif -%}
            {% evaluate pidrelatedPersonId using 'ID/RelatedPerson' PID: firstSegments.PID, baseId: patientId -%}
            {% include 'Resource/RelatedPerson' RelatedPerson_Patient_ID: fullPatientId, ID: pidrelatedPersonId, PID: firstSegments.PID -%}
            {% endif -%}
        {% endunless -%}
        
        {% if firstSegments.PD1.3 -%}
            {% evaluate Organization_ID_PD1_3 using 'ID/Organization' XON: firstSegments.PD1.3 -%}
            {% include 'Resource/Organization' PD1: firstSegments.PD1, ID: Organization_ID_PD1_3 -%}
        {% endif -%}

        {% if firstSegments.PD1.4 -%}
            {% if firstSegments.PD1.4.9.1 != "" and firstSegments.PD1.4.9.1 != null and firstSegments.PD1.4.9.2 != "" and firstSegments.PD1.4.9.2 != null and firstSegments.PD1.4.9.3 != "" and firstSegments.PD1.4.9.3 != null -%}
                {% evaluate Organization_ID_PD1_4_9 using 'ID/Organization' HDORG: firstSegments.PD1.4.9 -%}
                {% include 'Resource/Organization', PD1_4: firstSegments.PD1.4.9, ID: Organization_ID_PD1_4_9 -%}
            {% endif -%} 
            {% evaluate Practitioner_ID_PD1_4 using 'ID/Practitioner' XCN: firstSegments.PD1.4 -%}
            {% include 'Resource/Practitioner' PD1: firstSegments.PD1.4, ID: Practitioner_ID_PD1_4 -%}
        {% endif -%}

        {% if firstSegments.PV1 -%}
            {% if firstSegments.PV1.5 -%}
                {% if firstSegments.PV1.5.4.1 != "" and firstSegments.PV1.5.4.1 != null and firstSegments.PV1.5.4.2 != "" and firstSegments.PV1.5.4.2 != null and firstSegments.PV1.5.4.3 != "" and firstSegments.PV1.5.4.3 != null -%}
                    {% evaluate Organization_ID_PV1_5_4 using 'ID/Organization' HDORG: firstSegments.PV1.5.4 -%}
                    {% include 'Resource/Organization', PV1: firstSegments.PV1.5.4, ID: Organization_ID_PV1_5_4 -%}
                {% endif -%}
            {% endif -%}

            {% if firstSegments.PV1.19 -%}
                {% if firstSegments.PV1.19.4.1 != "" and firstSegments.PV1.19.4.1 != null and firstSegments.PV1.19.4.2 != "" and firstSegments.PV1.19.4.2 != null and firstSegments.PV1.19.4.3 != "" and firstSegments.PV1.19.4.3 != null -%}
                    {% evaluate Organization_ID_PV1_19_4 using 'ID/Organization' HDORG: firstSegments.PV1.19.4 -%}
                    {% include 'Resource/Organization', PV1: firstSegments.PV1.19.4, ID: Organization_ID_PV1_19_4 -%}
                {% endif -%}
            {% endif -%}

            {% if firstSegments.PV1.7 -%}
                {% if firstSegments.PV1.7.9.1 != "" and firstSegments.PV1.7.9.1 != null and firstSegments.PV1.7.9.2 != "" and firstSegments.PV1.7.9.2 != null and firstSegments.PV1.7.9.3 != "" and firstSegments.PV1.7.9.3 != null -%}
                    {% evaluate Organization_ID_PV1_7_9 using 'ID/Organization' HDORG: firstSegments.PV1.7.9 -%}
                    {% include 'Resource/Organization', PV1: firstSegments.PV1.7.9, ID: Organization_ID_PV1_7_9 -%}
                {% endif -%}
                {% evaluate practitionerId_PV1_7 using 'ID/Practitioner' XCN: firstSegments.PV1.7 -%}
                {% include 'Resource/Practitioner' PV1: firstSegments.PV1.7, ID: practitionerId_PV1_7 -%}
            {% endif -%}

            {% if firstSegments.PV1.8 -%}
                {% if firstSegments.PV1.8.9.1 != "" and firstSegments.PV1.8.9.1 != null and firstSegments.PV1.8.9.2 != "" and firstSegments.PV1.8.9.2 != null and firstSegments.PV1.8.9.3 != "" and firstSegments.PV1.8.9.3 != null -%}
                    {% evaluate Organization_ID_PV1_8_9 using 'ID/Organization' HDORG: firstSegments.PV1.8.9 -%}
                    {% include 'Resource/Organization', PV1: firstSegments.PV1.8.9, ID: Organization_ID_PV1_8_9 -%}
                {% endif -%}
                {% evaluate practitionerId_PV1_8 using 'ID/Practitioner' XCN: firstSegments.PV1.8 -%}
                {% include 'Resource/Practitioner' PV1: firstSegments.PV1.8, ID: practitionerId_PV1_8 -%}
            {% endif -%}

            {% if firstSegments.PV1.9 -%}
                {% if firstSegments.PV1.9.9.1 != "" and firstSegments.PV1.9.9.1 != null and firstSegments.PV1.9.9.2 != "" and firstSegments.PV1.9.9.2 != null and firstSegments.PV1.9.9.3 != "" and firstSegments.PV1.9.9.3 != null -%}
                    {% evaluate Organization_ID_PV1_9_9 using 'ID/Organization' HDORG: firstSegments.PV1.9.9 -%}
                    {% include 'Resource/Organization', PV1: firstSegments.PV1.9.9, ID: Organization_ID_PV1_9_9 -%}
                {% endif -%}        
                {% evaluate practitionerId_PV1_9 using 'ID/Practitioner' XCN: firstSegments.PV1.9 -%}
                {% include 'Resource/Practitioner' PV1: firstSegments.PV1.9, ID: practitionerId_PV1_9 -%}
            {% endif -%}

            {% if firstSegments.PV1.17 -%}
                {% if firstSegments.PV1.17.9.1 != "" and firstSegments.PV1.17.9.1 != null and firstSegments.PV1.17.9.2 != "" and firstSegments.PV1.17.9.2 != null and firstSegments.PV1.17.9.3 != "" and firstSegments.PV1.17.9.3 != null -%}
                    {% evaluate Organization_ID_PV1_17_9 using 'ID/Organization' HDORG: firstSegments.PV1.17.9 -%}
                    {% include 'Resource/Organization', PV1: firstSegments.PV1.17.9, ID: Organization_ID_PV1_17_9 -%}
                {% endif -%}         
                {% evaluate practitionerId_PV1_17 using 'ID/Practitioner' XCN: firstSegments.PV1.17 -%}
                {% include 'Resource/Practitioner' PV1: firstSegments.PV1.17, ID: practitionerId_PV1_17 -%}
            {% endif -%}

            {% if firstSegments.PV1.50 -%}
                {% for p in firstSegments.PV1.50.Repeats -%}
                    {% if p.4.1 != "" and p.4.1 != null and p.4.2 != "" and p.4.2 != null and p.4.3 != "" and p.4.3 != null -%}
                        {% evaluate Organization_ID_PV1_50_4 using 'ID/Organization' HDORG: p.4 -%}
                        {% include 'Resource/Organization', PV1: p.4, ID: Organization_ID_PV1_50_4 -%}
                    {% endif -%}
                {% endfor -%}
            {% endif -%}
                    
            {% if firstSegments.PV1.52 -%}
                {% if firstSegments.PV1.52.9.1 != "" and firstSegments.PV1.52.9.1 != null and firstSegments.PV1.52.9.2 != "" and firstSegments.PV1.52.9.2 != null and firstSegments.PV1.52.9.3 != "" and firstSegments.PV1.52.9.3 != null -%}
                    {% evaluate Organization_ID_PV1_52_9 using 'ID/Organization' HDORG: firstSegments.PV1.52.9 -%}
                    {% include 'Resource/Organization', PV1: firstSegments.PV1.52.9, ID: Organization_ID_PV1_52_9 -%}
                {% endif -%} 
                {% evaluate practitionerId_PV1_52 using 'ID/Practitioner' XCN: firstSegments.PV1.52 -%}
                {% include 'Resource/Practitioner' PV1: firstSegments.PV1.52, ID: practitionerId_PV1_52 -%}
            {% endif -%}

            {% if firstSegments.PV2.13 -%}
                {% if firstSegments.PV2.13.9.1 != "" and firstSegments.PV2.13.9.1 != null and firstSegments.PV2.13.9.2 != "" and firstSegments.PV2.13.9.2 != null and firstSegments.PV2.13.9.3 != "" and firstSegments.PV2.13.9.3 != null -%}
                    {% evaluate Organization_ID_PV2_13_9 using 'ID/Organization' HDORG: firstSegments.PV2.13.9 -%}
                    {% include 'Resource/Organization', PV2: firstSegments.PV2.13.9, ID: Organization_ID_PV2_13_9 -%}
                {% endif -%} 
                {% evaluate practitionerId_PV2_13 using 'ID/Practitioner' XCN: firstSegments.PV2.13 -%}
                {% include 'Resource/Practitioner' PV1: firstSegments.PV2.13, ID: practitionerId_PV2_13 -%}
            {% endif -%}

            {% if firstSegments.PV1.3 -%}
            {% include 'Resource/PLLocation' PL: firstSegments.PV1.3-%}
            {% endif -%}

            {% if firstSegments.PV1.6 -%}
            {% include 'Resource/PLLocation' PL: firstSegments.PV1.6 -%}
            {% endif -%}

            {% if firstSegments.PV1.11 -%}
                {% include 'Resource/PLLocation' PL: firstSegments.PV1.11-%}
            {% endif -%}

            {% if firstSegments.PV1.37 -%}
                {% evaluate location_ID_PV1_37 using 'ID/Location' DLD: firstSegments.PV1.37 -%}
                {% include 'Resource/Location' PV1: firstSegments.PV1.37, ID: location_ID_PV1_37-%}
            {% endif -%}

            {% if firstSegments.PV1.42 -%}
            {% include 'Resource/PLLocation' PL: firstSegments.PV1.42-%}
            {% endif -%}
        
            {% if firstSegments.PV1.43 -%}
            {% include 'Resource/PLLocation' PL: firstSegments.PV1.43-%}
            {% endif -%}

            {% if firstSegments.PV2.1 -%}
            {% include 'Resource/PLLocation' PL: firstSegments.PV2.1-%}
            {% endif -%}

            {% if firstSegments.PV1.54 -%}
                {% if firstSegments.PV1.54.4.1 != "" and firstSegments.PV1.54.4.1 != null and firstSegments.PV1.54.4.2 != "" and firstSegments.PV1.54.4.2 != null and firstSegments.PV1.54.4.3 != "" and firstSegments.PV1.54.4.3 != null -%}
                    {% evaluate Organization_ID_PV1_54_4 using 'ID/Organization' HDORG: firstSegments.PV1.54.4 -%}
                {% include 'Resource/Organization', PV1: firstSegments.PV1.54.4, ID: Organization_ID_PV1_54_4 -%}
                {% endif -%} 
                {% evaluate EpisodeOfCare_ID using 'ID/EpisodeOfCare' PV1: firstSegments.PV1.54 -%}
                {% include 'Resource/EpisodeOfCare' PV1: firstSegments.PV1, PV2: firstSegments.PV2, ID: EpisodeOfCare_ID, patientRefrenceID: fullPatientId -%}
            {% endif -%}

            {% evaluate encounterId using 'ID/Encounter' PV1: firstSegments.PV1, baseId: patientId -%}
            {% include 'Resource/Encounter' Root_Template: 'ORM_O01', PV1: firstSegments.PV1, PV2: firstSegments.PV2, ID: encounterId, AccountId:accountId -%}
            {% include 'Reference/Encounter/Subject' ID: encounterId, REF: fullPatientId -%}
            {% include 'Extensions/Encounter/EncounterExtension' ID: encounterId, PV1: firstSegments.PV1, PV2: firstSegments.PV2, -%}
        {% endif -%}

        {% for in1Segment in in1SegmentLists.IN1 -%}     
            {% assign in2SegmentLists = hl7v2Data | get_related_segment_list: in1Segment, 'IN2' -%}
            {% evaluate coverageId using 'ID/Coverage' CX: in1Segment -%}
            {% include 'Resource/Coverage' IN1: in1Segment, ID: coverageId -%}
            {% include 'Reference/Coverage/Beneficiary' ID: coverageId, REF: fullPatientId  -%}

            {% assign fullCoverageId = coverageId | prepend: 'Coverage/' -%}

            {% include 'Reference/Account/Coverage_Coverage' REF: fullCoverageId, ID: accountId -%}

            {% for in1_49 in in1Segment.49.Repeats -%}
                {% if in1_49.4.1 != "" and in1_49.4.1 != null and in1_49.4.2 != "" and in1_49.4.2 != null and in1_49.4.3 != "" and in1_49.4.3 != null -%}
                    {% evaluate Organization_ID_in1_CX_49 using 'ID/Organization' HDORG: in1_49.4 -%}
                    {% include 'Resource/Organization', IN1_49: in1_49, ID: Organization_ID_in1_CX_49 -%}
                {% endif -%}
            {% endfor -%}

            {% for in1_3 in in1Segment.3.Repeats -%}
                {% if in1_3.4.1 != "" and in1_3.4.1 != null and in1_3.4.2 != "" and in1_3.4.2 != null and in1_3.4.3 != "" and in1_3.4.3 != null -%}
                    {% evaluate Organization_ID_in1_CX_3 using 'ID/Organization' HDORG: in1_3.4 -%}
                    {% include 'Resource/Organization', IN1_3: in1_3, ID: Organization_ID_in1_CX_3 -%}
                {% endif -%}
            {% endfor -%}

            {% for in1_10 in in1Segment.10.Repeats -%}
                {% if in1_10.4.1 != "" and in1_10.4.1 != null and in1_10.4.2 != "" and in1_10.4.2 != null and in1_10.4.3 != "" and in1_10.4.3 != null -%}
                    {% evaluate Organization_ID_in1_CX_10 using 'ID/Organization' HDORG: in1_10.4 -%}
                    {% include 'Resource/Organization', IN1_10: in1_10, ID: Organization_ID_in1_CX_10 -%}
                {% endif -%}
            {% endfor -%}

            {% if in1Segment.4 -%}
                {% evaluate Organization_ID_in1_4 using 'ID/Organization' XON: in1Segment.4 -%}
            {% else -%}
                {% evaluate Organization_ID_in1_4 using 'ID/Organization' CX: in1Segment -%}
            {% endif -%}
            {% if Organization_ID_in1_4 -%}
                {% include 'Resource/Organization', IN1: in1Segment, ID: Organization_ID_in1_4 -%}
                {% assign org_in1_4 = Organization_ID_in1_4 | prepend: 'Organization/' -%}
                {% include 'Reference/Coverage/Payor' ID: coverageId, REF: org_in1_4  -%}
            {% endif -%}

            {% if in1Segment.11 -%}
                {% evaluate Organization_ID_in1_11 using 'ID/Organization' XON: in1Segment.11 -%}
            {% else -%}
                {% evaluate Organization_ID_in1_11 using 'ID/Organization' CX_IN1: in1Segment -%}
            {% endif -%}
            {% if Organization_ID_in1_11 -%}
                {% include 'Resource/Organization', IN1_11: in1Segment, ID: Organization_ID_in1_11 -%}
                {% assign org_in1_11 = Organization_ID_in1_11 | prepend: 'Organization/' -%}
                {% include 'Reference/Coverage/PolicyHolder' ID: coverageId, REF: org_in1_11  -%}
            {% endif -%}

            {% if in1Segment.17.1.Value == "SEL" -%}
                {% include 'Resource/Patient' PID_IN1: firstSegments.PID, IN1: in1Segment, ID: patientId -%}
                {% include 'Reference/Coverage/Subscriber' ID: coverageId, REF: fullPatientId  -%}
            {% endif -%}
            {% unless in1Segment.17.1.Value == "SEL" or in1Segment.17.Value == "" -%}
                {% evaluate in1relatedPersonId using 'ID/RelatedPerson' IN1: in1Segment, baseId: patientId -%}
                {% include 'Resource/RelatedPerson' RelatedPerson_Patient_ID: fullPatientId, ID: in1relatedPersonId, IN1: in1Segment -%}
                {% assign rel_in1_17 = in1relatedPersonId | prepend: 'RelatedPerson/' -%}
                {% include 'Reference/Coverage/Subscriber' ID: coverageId, REF: rel_in1_17  -%}
            {% endunless -%}

            {% for in2Segment in in2SegmentLists.IN2 -%}
                {% if in1Segment.17.1.Value == "SEL" -%}
                    {% include 'Resource/Patient' IN2: in2Segment, ID: patientId -%}  
                {% endif -%}        
                {% unless in1Segment.17.1.Value == "SEL" or in1Segment.17.Value == "" -%}
                    {% include 'Resource/RelatedPerson' RelatedPerson_Patient_ID: fullPatientId, ID: in1relatedPersonId, IN2: in2Segment -%}
                {% endunless -%}   

                {% unless in1Segment.10 and in1Segment.11 -%}
                    {% if in2Segment.3 -%}
                        {% evaluate in2relatedPersonId using 'ID/RelatedPerson' IN2: in2Segment, baseId: patientId -%}
                        {% if in2Segment.3.9.1 != "" and in2Segment.3.9.1 != null and in2Segment.3.9.2 != "" and in2Segment.3.9.2 != null and in2Segment.3.9.3 != "" and in2Segment.3.9.3 != null -%}
                            {% evaluate Organization_ID_IN2_3_9 using 'ID/Organization' HDORG: in2Segment.3.9 -%}
                            {% include 'Resource/Organization', IN2_3: in2Segment.3.9, ID: Organization_ID_IN2_3_9 -%}
                        {% endif -%}
                        {% include 'Resource/RelatedPerson' RelatedPerson_Patient_ID: fullPatientId, ID: in2relatedPersonId, IN2_3: in2Segment -%}
                        {% assign relatedperson_3 = in2relatedPersonId | prepend: 'RelatedPerson/' -%}
                        {% include 'Reference/Coverage/PolicyHolder' ID: coverageId, REF: relatedperson_3  -%}
                    {% endif -%}
                {% endunless -%} 

                {% if in1Segment.10 == null and in1Segment.11 == null and in2Segment.3 == null -%}
                    {% if in2Segment.70 -%}
                        {% evaluate organization_Id_IN2_70 using 'ID/Organization' XON: in2Segment.70 -%}
                        {% include 'Resource/Organization' IN2_70: in2Segment, ID: organization_Id_IN2_70 -%}                   
                        {% assign org_in2_70 = organization_Id_IN2_70 | prepend: 'Organization/' -%}
                        {% include 'Reference/Coverage/PolicyHolder' ID: coverageId, REF: org_in2_70  -%}
                    {% endif -%}
                {% endif -%}
        
                {% if Organization_ID_in1_11 -%}
                    {% include 'Resource/Organization', IN2_49: in2Segment, ID: Organization_ID_in1_11 -%}
                {% endif -%}
                {% include 'Resource/Coverage' IN2: in2Segment, ID: coverageId -%}
                {% include 'Resource/Patient' IN2_6: in2Segment, ID: patientId -%}
                
                {% for in2_1 in in2Segment.1.Repeats -%}
                    {% if in2_1.4.1 != "" and in2_1.4.1 != null and in2_1.4.2 != "" and in2_1.4.2 != null and in2_1.4.3 != "" and in2_1.4.3 != null -%}
                        {% evaluate Organization_ID_in2_CX_1 using 'ID/Organization' HDORG: in2_1.4 -%}
                        {% include 'Resource/Organization', IN2_1: in2_1, ID: Organization_ID_in2_CX_1 -%}
                    {% endif -%}
                {% endfor -%}
                {% if in2Segment.61 -%}
                    {% if in2Segment.61.4.1 != "" and in2Segment.61.4.1 != null and in2Segment.61.4.2 != "" and in2Segment.61.4.2 != null and in2Segment.61.4.3 != "" and in2Segment.61.4.3 != null -%}
                        {% evaluate Organization_ID_in2_CX_61 using 'ID/Organization' HDORG: in2Segment.61.4 -%}
                        {% include 'Resource/Organization', IN2_61: in2Segment.61, ID: Organization_ID_in2_CX_61 -%}
                    {% endif -%}
                {% endif -%}
            {% endfor -%}

        {% endfor -%}

        {% for al1Segment in al1SegmentLists.AL1 -%}
            {% evaluate allergyIntoleranceId using 'ID/AllergyIntolerance' AL1: al1Segment, baseId: patientId -%}
            {% include 'Resource/AllergyIntolerance' AL1: al1Segment, ID: allergyIntoleranceId, AllergyIntolerance_Patient_ID: fullPatientId -%}
        {% endfor -%}

        {%- comment -%}
            In ORM message type OBR and ODS segments are conditional under ORDER DETAIL SEGMENT group and these segments are only comes under this group only.
            So, we are assigning all OBR and ODS segments which are come under diffrent ORDER DETAIL SEGMENT groups to obrSegmentLists and odsSegmentLists respectively.
            And we used this lists to check which OBR and ODS segments comes after ORC segment.  
        {%- endcomment -%}
        {% assign obrSegmentLists = hl7v2Data | get_segment_lists: 'OBR' -%}
        {% assign odsSegmentLists = hl7v2Data | get_segment_lists: 'ODS' -%}
        {% assign rqdSegmentLists = hl7v2Data | get_segment_lists: 'RQD' -%}
        {% assign rxoSegmentLists = hl7v2Data | get_segment_lists: 'RXO' -%}

      
        {% for orcSegment in orcSegmentLists.ORC -%}

            {% assign ctdSegmentLists = hl7v2Data | get_related_segment_list: orcSegment, 'CTD' -%}
            {% assign dg1SegmentLists = hl7v2Data | get_related_segment_list: orcSegment, 'DG1' -%}
            {% assign obxSegmentLists = hl7v2Data | get_related_segment_list: orcSegment, 'OBX' -%}
            {% assign nteSegmentLists1 = hl7v2Data | get_related_segment_list: orcSegment, 'NTE' -%}

            {% assign checkParent = orcSegment %}
            {% assign serviceRequestId = null %} {%- comment -%} assigning serviceRequestId variable to null, so it will not used the previously assigned values. Ex. for second order group it should not used first order group ID {%- endcomment -%}
            
            {% assign orcSegmentPositionIndex = 0 -%}
            {% for obrSegment in obrSegmentLists.OBR -%}
                {% assign checkParentORCOFOBR = hl7v2Data | get_parent_segment: 'OBR', {{orcSegmentPositionIndex}}, 'ORC' -%}
                {% assign orcSegmentPositionIndex = orcSegmentPositionIndex | plus: 1 -%}
                {% if checkParentORCOFOBR.ORC.Value == orcSegment.Value %}
                    {%- comment -%}
                        In this if condition we are checking the value of currect ORC segment to the parent ORC segment of each OBR segments, If values matched then we can concluding that current OBR segment is the part of ORC seegment on which we are working on. 
                    {%- endcomment -%}
            
                    {% evaluate parentServiceRequestId_orc using 'ID/ServiceRequest' ORC: checkParent.31, baseId: patientId -%}
                    {% if obrSegment.29.Value == null %}
                        {% if checkParent.8 and checkParent.31 %}
                            {% include 'Resource/ServiceRequest' OBR: obrSegment, ORC: checkParent, ID: parentServiceRequestId_orc, ServiceRequest_Subject_ID: fullPatientId, type_msg: "ORM" -%}                   
                        {% endif %}
                    {% endif %}

                    {% evaluate serviceRequestId using 'ID/ServiceRequest' ORC: checkParent, OBR_OML_ORM: obrSegment, OML_ORM_MSH:firstSegments.MSH, baseId: patientId -%}
                    {% assign reasonRefrenceServiceRequestId = serviceRequestId -%}
                    {% evaluate specimenId_obr using 'ID/Specimen' OBR: obrSegment -%}
                    {% assign fullSpecimenId_obr = specimenId_obr | prepend: 'Specimen/' -%}
                    {% evaluate parentServiceRequestId using 'ID/ServiceRequest' OBR_29: obrSegment.29, baseId: patientId -%}
                    {% include 'Resource/ServiceRequest' OBR_child: obrSegment, parentSegment: checkParent, ServiceRequest_Subject_ID: fullPatientId, ServiceRequest_ID_OBR_29: parentServiceRequestId, ServiceRequest_ID_ORC_8: parentServiceRequestId_orc, ID: serviceRequestId, type_msg: "ORM" -%}  

                    {% assign fullencounterID = encounterId | prepend: 'Encounter/' -%}
                    {% include 'Reference/ServiceRequest/Encounter' REF: fullencounterID, ID: serviceRequestId -%}                          
                    
                    {% assign organizationId_ORC_21 = null %}
                    {% if checkParent.21 %}
                        {% evaluate organizationId_ORC_21 using 'ID/Organization' XON: checkParent.21.Repeats[0] -%}
                        {% include 'Resource/Organization' ORC_SEG: checkParent, ORC_SEG_22: checkParent.22, ORC_SEG_23: checkParent.23, ID: organizationId_ORC_21 -%}
                        {% evaluate practitionerRoleId_ORC_21 using 'ID/PractitionerRole' XCN: checkParent.21.Repeats[0]-%}
                    {% endif %}
                    {% if obrSegment.16 -%}
                        {% if obrSegment.16.Repeats[0] %}
                            {% if obrSegment.16.Repeats[0].9.1 != "" and obrSegment.16.Repeats[0].9.1 != null and obrSegment.16.Repeats[0].9.2 != "" and obrSegment.16.Repeats[0].9.2 != null and obrSegment.16.Repeats[0].9.3 != "" and obrSegment.16.Repeats[0].9.3 != null -%}
                                {% evaluate Organization_ID_OBR16 using 'ID/Organization' HDORG: obrSegment.16.Repeats[0].9 -%}
                                {% include 'Resource/Organization' OBR_SEG_16: obrSegment.16.Repeats[0].9, ID: Organization_ID_OBR16 -%}
                            {% endif -%}
                        {% endif -%}  
                        {% evaluate practitionerId_OBR_16 using 'ID/Practitioner' XCN: obrSegment.16.Repeats[0] -%}
                        {% include 'Resource/Practitioner' OBR_SEG: obrSegment, OBRXCN_16: obrSegment.16.Repeats[0], ORC_SEG_24: checkParent.24, ID: practitionerId_OBR_16 -%}
                        {% evaluate practitionerRoleId_OBR_16 using 'ID/PractitionerRole' XCN: obrSegment.16.Repeats[0]-%}
                        {% include 'Resource/PractitionerRole' OBR_serv: obrSegment, requestor_practitioner1: practitionerId_OBR_16, requestor_organization: organizationId_ORC_21, ID: practitionerRoleId_OBR_16 -%}
                        {% assign fullpractitionerRoleId_OBR_16 = practitionerRoleId_OBR_16 | prepend: 'PractitionerRole/' -%}
                        {% include 'Reference/ServiceRequest/Requester' REF: fullpractitionerRoleId_OBR_16, ID: serviceRequestId -%}                  
                    {% else %}
                        {% if checkParent.12 %}
                            {% evaluate practitionerId_ORC_12 using 'ID/Practitioner' XCN: checkParent.12.Repeats[0] -%}
                            {% if checkParent.12.Repeats[0].9.1 != "" and checkParent.12.Repeats[0].9.1 != null and checkParent.12.Repeats[0].9.2 != "" and checkParent.12.Repeats[0].9.2 != null and checkParent.12.Repeats[0].9.3 != "" and checkParent.12.Repeats[0].9.3 != null -%}
                                {% evaluate Organization_ID_ORC_12 using 'ID/Organization' HDORG: checkParent.12.Repeats[0].9 -%}
                                {% include 'Resource/Organization' ORC_SEG_12: checkParent.12.Repeats[0].9, ID: Organization_ID_ORC_12 -%}
                            {% endif -%}
                            {% include 'Resource/Practitioner' ORC_SEG: checkParent, ORCXCN_12: checkParent.12.Repeats[0], ORC_SEG_24: checkParent.24, ID: practitionerId_ORC_12 -%}  
                            {% evaluate practitionerRoleId_ORC_12 using 'ID/PractitionerRole' XCN: checkParent.12.Repeats[0]-%}
                            {% include 'Resource/PractitionerRole' ORC_pracrole: checkParent, requestor_practitioner2: practitionerId_ORC_12, requestor_organization: organizationId_ORC_21, ID: practitionerRoleId_ORC_12 -%}
                            {% assign fullPractitionerRoleId_ORC_12 = practitionerRoleId_ORC_12 | prepend: 'PractitionerRole/' -%}
                            {% include 'Reference/ServiceRequest/Requester' REF: fullPractitionerRoleId_ORC_12, ID: serviceRequestId -%}             
                        {% else %}
                            {% if checkParent.21 %}
                                {% evaluate organizationId_ORC_21 using 'ID/Organization' XON: checkParent.21.Repeats[0] -%}
                                {% if checkParent.12.Repeats[0] == null or checkParent.12.Repeats[0] == ""  -%}
                                    {% include 'Resource/Organization' ORC_SEG: checkParent, ORC_SEG_22: checkParent.22, ORC_SEG_23: checkParent.23, ID: organizationId_ORC_21 -%}
                                {% endif %}
                                {% evaluate practitionerRoleId_ORC_21 using 'ID/PractitionerRole' XCN: checkParent.21.Repeats[0]-%}
                                {% include 'Resource/PractitionerRole' requestor_organization: organizationId_ORC_21, ID: practitionerRoleId_ORC_21 -%}
                                {% assign fullPractitionerRoleId_ORC_21 = practitionerRoleId_ORC_21 | prepend: 'PractitionerRole/' -%}
                                {% include 'Reference/ServiceRequest/Requester' REF: fullPractitionerRoleId_ORC_21, ID: serviceRequestId -%} 
                            {% endif %}
                        {% endif -%}
                    {% endif %}

                    {% include 'Reference/ServiceRequest/Specimen' REF: fullSpecimenId_obr, ID: serviceRequestId -%}
                
                    {% if obrSegment.29 %}
                        {% if obrSegment.50 -%}
                            {% evaluate parentServiceRequestId using 'ID/ServiceRequest' OBR_29: obrSegment.29, baseId: patientId -%}
                            {% include 'Resource/ServiceRequest' OBR_parent: obrSegment, parentSegment: checkParent, ServiceRequest_Subject_ID: fullPatientId, ID: parentServiceRequestId, type_msg: "ORM" -%}
                        {% endif %}
                    {% endif %}
                    
                    {% assign fullParentServiceRequestId = parentServiceRequestId | prepend: 'ServiceRequest/' -%}
                    
                    {% for nteSegment1 in nteSegmentLists1.NTE -%}
                        {% if nteSegment1.5 -%}    
                            {% if nteSegment1.5.9.1 != "" and nteSegment1.5.9.1 != null and nteSegment1.5.9.2 != "" and nteSegment1.5.9.2 != null and nteSegment1.5.9.3 != "" and nteSegment1.5.9.3 != null -%}
                                {% evaluate Organization_ID_NTE1_5_9 using 'ID/Organization' HDORG: nteSegment1.5.9 -%}
                                {% include 'Resource/Organization' OBR_NTE: nteSegment1.5.9, ID: Organization_ID_NTE1_5_9 -%}
                            {% endif -%}     
                            {% evaluate practitioner_ID_NTE_5 using 'ID/Practitioner' XCN: nteSegment1.5 -%}
                            {% include 'Resource/Practitioner' NTE: nteSegment1.5, ID: practitioner_ID_NTE_5 -%}
                        {% endif -%} 
                        {% include 'Resource/ServiceRequest' NTE: nteSegment1, ID: serviceRequestId -%}
                    {% endfor -%}

                    {% if obrSegment %}
                        {% include 'Resource/Specimen' OBR: obrSegment, ID: specimenId_obr -%}
                    {% endif %} 
                    
                    {% if obrSegment.10 %}
                        {% if obrSegment.10.Repeats[0].9.1 != "" and obrSegment.10.Repeats[0].9.1 != null and obrSegment.10.Repeats[0].9.2 != "" and obrSegment.10.Repeats[0].9.2 != null and obrSegment.10.Repeats[0].9.3 != "" and obrSegment.10.Repeats[0].9.3 != null -%}
                            {% evaluate Organization_ID_OBR10 using 'ID/Organization' HDORG: obrSegment.10.Repeats[0].9 -%}
                            {% include 'Resource/Organization' OBR_SEG_10: obrSegment.10.Repeats[0].9, ID: Organization_ID_OBR10 -%}
                        {% endif -%}     
                        {% evaluate practitionerId_OBR_10 using 'ID/Practitioner' XCN: obrSegment.10.Repeats[0] -%}
                        {% include 'Resource/Practitioner' OBR_SEG: obrSegment, OBRXCN_10: obrSegment.10.Repeats[0], ID: practitionerId_OBR_10 -%}
                        {% evaluate practitionerRoleId_OBR_10 using 'ID/PractitionerRole' XCN: obrSegment.10.Repeats[0] -%}
                        {% assign full_practitionerId_obr_10 = practitionerRoleId_OBR_10 | prepend: 'PractitionerRole/' %}    
                        {% include 'Resource/PractitionerRole' OBR: obrSegment, collection_collector_practitioner: practitionerId_obr_10, ID: practitionerRoleId_OBR_10 -%}
                        {% include 'Reference/Specimen/Collection_Collector' REF: full_practitionerId_obr_10, ID: specimenId_obr -%}
                    {% endif -%}            
                {% endif %}
            {% endfor -%}

            {% assign NutritionOrder = null %}
            {% assign orcSegmentPositionIndex = 0 -%}
            {% for odsSegment in odsSegmentLists.ODS -%}

                {% assign nteSegmentLists_ODS = hl7v2Data | get_related_segment_list: odsSegment, 'NTE' -%}

                {% assign checkParentORCOFODS = hl7v2Data | get_parent_segment: 'ODS', {{orcSegmentPositionIndex}}, 'ORC' -%}
                {% assign orcSegmentPositionIndex = orcSegmentPositionIndex | plus: 1 -%}
                {% if checkParentORCOFODS.ORC.Value == orcSegment.Value %}
                    
                    {%- comment -%}
                        In this if condition we are checking the value of currect ORC segment to the parent ORC segment of each ODS segments, If values matched then we are concluding that current ODS segment is the part of ORC seegment on which we are working on. 
                    {%- endcomment -%}                 

                    {% evaluate NutritionOrder using 'ID/NutritionOrder' ODS: orcSegment -%}
                    {% assign fullEncounterId = encounterId | prepend: 'Encounter/' -%}
                    {% assign fullallergyIntoleranceId = allergyIntoleranceId | prepend: 'AllergyIntolerance/' -%}
                    {% include 'Resource/NutritionOrder' ORC: orcSegment, MSH: firstSegments.MSH, ID: NutritionOrder, NutritionOrder_Patient_ID: fullPatientId, NutritionOrder_Encounter_ID: fullEncounterId, NutritionOrder_AllergyIntolerance_ID: fullallergyIntoleranceId -%}

                    {% if orcSegment.12 %}
                        {% if orcSegment.12.Repeats[0].9.1 != "" and orcSegment.12.Repeats[0].9.1 != null and orcSegment.12.Repeats[0].9.2 != "" and orcSegment.12.Repeats[0].9.2 != null and orcSegment.12.Repeats[0].9.3 != "" and orcSegment.12.Repeats[0].9.3 != null -%}
                            {% evaluate Organization_ID_ORC_12 using 'ID/Organization' HDORG: orcSegment.12.Repeats[0].9 -%}
                            {% include 'Resource/Organization' ORC_SEG_12: orcSegment.12.Repeats[0].9, ID: Organization_ID_ORC_12 -%}
                        {% endif -%}
                        {% evaluate practitionerId_ORC_12 using 'ID/Practitioner' XCN: orcSegment.12.Repeats[0] -%}
                        {% include 'Resource/Practitioner' ORC_SEG: orcSegment, ORCXCN_12: orcSegment.12.Repeats[0], ORC_SEG_24: orcSegment.24, ID: practitionerId_ORC_12 -%}

                        {% if orcSegment.21 %}
                            {% evaluate organizationId_ORC_21 using 'ID/Organization' XON: orcSegment.21.Repeats[0] -%}
                            {% include 'Resource/Organization' ORC_SEG: orcSegment, ORC_SEG_22: orcSegment.22, ORC_SEG_23: orcSegment.23, ID: organizationId_ORC_21 -%}
                            {% evaluate practitionerRoleId_ORC_21 using 'ID/PractitionerRole' XCN: orcSegment.21.Repeats[0]-%}
                        {% endif %}
                        {% evaluate practitionerRoleId_ORC_12 using 'ID/PractitionerRole' XCN: orcSegment.12.Repeats[0]-%}
                        {% include 'Resource/PractitionerRole' ORC_pracrole: orcSegment, requestor_practitioner1: practitionerId_ORC_12, requestor_organization: organizationId_ORC_21, ID: practitionerRoleId_ORC_12 -%}
                        {% assign fullPractitionerRoleId_ORC_12 = practitionerRoleId_ORC_12 | prepend: 'PractitionerRole/' -%}
                        {% include 'Reference/NutritionOrder/Orderer' REF: fullPractitionerRoleId_ORC_12, ID: NutritionOrder -%}
                    {% else %}
                        {% if orcSegment.21 %}
                            {% evaluate organizationId_ORC_21 using 'ID/Organization' XON: orcSegment.21.Repeats[0] -%}
                            {% if orcSegment.12.Repeats[0] == null or orcSegment.12.Repeats[0] == ""  -%}
                                {% include 'Resource/Organization' ORC_SEG: orcSegment, ORC_SEG_22: orcSegment.22, ORC_SEG_23: orcSegment.23, ID: organizationId_ORC_21 -%}
                            {% endif %}
                            {% evaluate practitionerRoleId_ORC_21 using 'ID/PractitionerRole' XCN: orcSegment.21.Repeats[0]-%}
                            {% include 'Resource/PractitionerRole' ORC: orcSegment, requestor_organization: organizationId_ORC_21, ID: practitionerRoleId_ORC_21 -%}
                            {% assign fullPractitionerRoleId_ORC_21 = practitionerRoleId_ORC_21 | prepend: 'PractitionerRole/' -%}
                            {% include 'Reference/NutritionOrder/Orderer' REF: fullPractitionerRoleId_ORC_21, ID: NutritionOrder -%}
                        {% endif %}
                    {% endif -%}                

                    {% include 'Resource/NutritionOrder' ODS: odsSegment, ORC: orcSegment, ID: NutritionOrder, NutritionOrder_Patient_ID: fullPatientId, NutritionOrder_Encounter_ID: fullEncounterId, NutritionOrder_AllergyIntolerance_ID: fullallergyIntoleranceId -%}
                    
                    {% for nteSegment1 in nteSegmentLists_ODS.NTE -%}
                        {% if nteSegment1.5 -%}    
                            {% if nteSegment1.5.9.1 != "" and nteSegment1.5.9.1 != null and nteSegment1.5.9.2 != "" and nteSegment1.5.9.2 != null and nteSegment1.5.9.3 != "" and nteSegment1.5.9.3 != null -%}
                                {% evaluate Organization_ID_NTE1_5_9 using 'ID/Organization' HDORG: nteSegment1.5.9 -%}
                                {% include 'Resource/Organization' OBR_NTE: nteSegment1.5.9, ID: Organization_ID_NTE1_5_9 -%}
                            {% endif -%}     
                            {% evaluate practitioner_ID_NTE_5 using 'ID/Practitioner' XCN: nteSegment1.5 -%}
                            {% include 'Resource/Practitioner' NTE: nteSegment1.5, ID: practitioner_ID_NTE_5 -%}
                        {% endif -%} 
                        {% include 'Resource/NutritionOrder' NTE: nteSegment1, ID: NutritionOrder -%}
                    {% endfor -%}

                    {%- comment -%}
                    {%- endcomment -%}
                {% endif %}
            {% endfor -%}

            {% assign supplyRequestID = null %}
            {% assign orcSegmentPositionIndex = 0 -%}
            {% for rqdSegment in rqdSegmentLists.RQD -%}
                {% assign checkParentORCOFRQD = hl7v2Data | get_parent_segment: 'RQD', {{orcSegmentPositionIndex}}, 'ORC' -%}
                {% assign orcSegmentPositionIndex = orcSegmentPositionIndex | plus: 1 -%}
                {% if checkParentORCOFRQD.ORC.Value == orcSegment.Value %}
                    {%- comment -%}
                        In this if condition we are checking the value of currect ORC segment to the parent ORC segment of each OBR segments, If values matched then we can concluding that current OBR segment is the part of ORC seegment on which we are working on. 
                    {%- endcomment -%}
            
                    {% evaluate supplyRequestID using 'ID/SupplyRequest' ORC: orcSegment, RQD: rqdSegment -%}
                    {% include 'Resource/SupplyRequest' ORC: orcSegment, RQD: rqdSegment, ID: supplyRequestID -%}
                        
                    {% if orcSegment.12.Repeats[0] -%}                    
                        {% if orcSegment.12.Repeats[0].9.1 != "" and orcSegment.12.Repeats[0].9.1 != null and orcSegment.12.Repeats[0].9.2 != "" and orcSegment.12.Repeats[0].9.2 != null and orcSegment.12.Repeats[0].9.3 != "" and orcSegment.12.Repeats[0].9.3 != null -%}
                            {% evaluate Organization_ID_ORC_12 using 'ID/Organization' HDORG: orcSegment.12.Repeats[0].9 -%}
                            {% include 'Resource/Organization' ORC_12: orcSegment.12.Repeats[0].9, ID: Organization_ID_ORC_12 -%}
                        {% endif -%}

                        {% evaluate practitionerId_ORC_12 using 'ID/Practitioner' XCN: orcSegment.12.Repeats[0] -%}
                        {% include 'Resource/Practitioner' ORC_12: orcSegment.12.Repeats[0], ORC_24:orcSegment.24, ID: practitionerId_ORC_12 -%}
                        {% evaluate practitionerRoleId_ORC_12 using 'ID/PractitionerRole' XCN: orcSegment.12.Repeats[0] -%}
                        {% assign full_practitionerId_ORC_12 = practitionerId_ORC_12 | prepend: 'Practitioner/' %}
                        {% include 'Resource/PractitionerRole' RQD_ORC_12: orcSegment.12.Repeats[0], ID: practitionerRoleId_ORC_12 -%}   
                        {% include 'Reference/PractitionerRole/Practitioner' REF: full_practitionerId_ORC_12, ID: practitionerRoleId_ORC_12 -%}

                        {% if orcSegment.21.Repeats[0] -%}    
                            {% evaluate organization_ID_ORC_21 using 'ID/Organization' XON: orcSegment.21.Repeats[0] -%}
                            {% include 'Resource/Organization' ORC: orcSegment, ID: organization_ID_ORC_21 -%}
                            {% assign full_OrganizationId_ORC_21 = organization_ID_ORC_21 | prepend: 'Organization/' %}
                            {% include 'Reference/PractitionerRole/Organization' REF: full_OrganizationId_ORC_21, ID: practitionerRoleId_ORC_12 -%}
                        {% endif %}
                    {% elsif orcSegment.21.Repeats[0] %}
                            {% evaluate practitionerRoleId_ORC_21 using 'ID/PractitionerRole' XCN: orcSegment.21.Repeats[0] -%}
                            {% evaluate organization_ID_ORC_21 using 'ID/Organization' XON: orcSegment.21.Repeats[0] -%}
                            {% include 'Resource/Organization' ORC: orcSegment, ID: organization_ID_ORC_21 -%}
                            {% assign full_OrganizationId_ORC_21 = organization_ID_ORC_21 | prepend: 'Organization/' %}
                            {% include 'Reference/PractitionerRole/Organization' REF: full_OrganizationId_ORC_21, ID: practitionerRoleId_ORC_21 -%}
                    {% endif -%}

                    {% if rqdSegment.9 -%}  
                        {% evaluate organizationID_RQD_9 using 'ID/Organization' CWE: rqdSegment.9 -%}
                        {% include 'Resource/Organization' RQD: rqdSegment.9, ID: organizationID_RQD_9 -%}
                    {% endif -%}

                    {% assign rq1SegmentLists = hl7v2Data | get_related_segment_list: rqdSegment, 'RQ1' -%}
                    {% assign rq1Segment = rq1SegmentLists.RQ1[0] %}

                    {% if rq1Segment.2 -%}  
                        {% evaluate IDorganization_RQ1_2 using 'ID/Organization' CWE: rq1Segment.2 -%}
                        {% include 'Resource/Organization' RQ1_2: rq1Segment, ID: IDorganization_RQ1_2 -%}
                    {% endif -%}

                    {% if rq1Segment.4 -%}  
                        {% evaluate IDorganization_RQ1_4 using 'ID/Organization' CWE: rq1Segment.4 -%}
                        {% include 'Resource/Organization' RQ1_4: rq1Segment, ID: IDorganization_RQ1_4 -%}
                    {% endif -%}

                    {% include 'Resource/SupplyRequest' organizationID_RQ1_2: IDorganization_RQ1_2, organizationID_RQ1_4: IDorganization_RQ1_4, ID: supplyRequestID -%}
            
                {% endif %}
            {% endfor -%}

            {% assign medicationRequestId = null %}
            {% assign orcSegment_7_firstRep = orcSegment.7.Repeats[0] %}
            {% assign orcSegmentPositionIndex = 0 -%}
            {% for rxoSegment in rxoSegmentLists.RXO -%}

                {% assign nteSegmentLists_RXO = hl7v2Data | get_related_segment_list: rxoSegment, 'NTE' -%}

                {% assign checkParentORCOFRXO = hl7v2Data | get_parent_segment: 'RXO', {{orcSegmentPositionIndex}}, 'ORC' -%}
                {% assign orcSegmentPositionIndex = orcSegmentPositionIndex | plus: 1 -%}
                {% if checkParentORCOFRXO.ORC.Value == orcSegment.Value %}
                    {%- comment -%}
                        In this if condition we are checking the value of currect ORC segment to the parent ORC segment of each RXO segments, If values matched then we can concluding that current RXO segment is the part of ORC seegment on which we are working on. 
                    {%- endcomment -%}
                    {% evaluate medicationRequestId using 'ID/MedicationRequest' ORC: orcSegment, RXO: rxoSegment, intent_value: 'original-order', baseId: patientId -%}
                    {% if rxoSegment %}
                        {% assign full_organizationId_ORC_21 = null -%}
                        {% if orcSegment.21.Repeats[0] %}
                            {% evaluate organizationId_ORC_21 using 'ID/Organization' XON: orcSegment.21.Repeats[0] -%}
                            {% assign full_organizationId_ORC_21 = organizationId_ORC_21 | prepend: 'Organization/' -%}
                            {% include 'Resource/Organization' ORC_SEG: orcSegment, ORC_SEG_22: orcSegment.22, ORC_SEG_23: orcSegment.23, ID: organizationId_ORC_21 -%}
                        {% endif -%}  
                        {% unless orcSegment.12 -%} 
                            {% if rxoSegment.14.Repeats[0] -%}                    
                                {% if rxoSegment.14.Repeats[0].9.1 != "" and rxoSegment.14.Repeats[0].9.1 != null and rxoSegment.14.Repeats[0].9.2 != "" and rxoSegment.14.Repeats[0].9.2 != null and rxoSegment.14.Repeats[0].9.3 != "" and rxoSegment.14.Repeats[0].9.3 != null -%}
                                    {% evaluate Organization_ID_RXO_14 using 'ID/Organization' HDORG: rxoSegment.14.Repeats[0].9 -%}
                                    {% include 'Resource/Organization' RXO_14: rxoSegment.14.Repeats[0].9, ID: Organization_ID_RXO_14 -%}
                                {% endif -%}
                                {% evaluate practitionerId_RXO_14 using 'ID/Practitioner' XCN: rxoSegment.14.Repeats[0] -%}
                                {% include 'Resource/Practitioner' RXO: rxoSegment.14.Repeats[0], ID: practitionerId_RXO_14 -%}
                                {% evaluate practitionerRoleId_RXO_14 using 'ID/PractitionerRole' XCN: rxoSegment.14.Repeats[0] -%}
                                {% assign full_practitionerId_RXO_14 = practitionerId_RXO_14 | prepend: 'Practitioner/' %}
                                {% include 'Resource/PractitionerRole' RXO: rxoSegment.14.Repeats[0], ID: practitionerRoleId_RXO_14 -%}   
                                {% include 'Reference/PractitionerRole/Practitioner' REF: full_practitionerId_RXO_14, ID: practitionerRoleId_RXO_14 -%}
                                {% if orcSegment.21.Repeats[0] %}
                                    {% include 'Reference/PractitionerRole/Organization' REF: full_organizationId_ORC_21, ID: practitionerRoleId_RXO_14 -%}
                                {% endif -%}
                            {% endif -%}
                        {% endunless -%}
                        {% if orcSegment.12.Repeats[0] -%}                    
                            {% if orcSegment.12.Repeats[0].9.1 != "" and orcSegment.12.Repeats[0].9.1 != null and orcSegment.12.Repeats[0].9.2 != "" and orcSegment.12.Repeats[0].9.2 != null and orcSegment.12.Repeats[0].9.3 != "" and orcSegment.12.Repeats[0].9.3 != null -%}
                                {% evaluate Organization_ID_ORC_12 using 'ID/Organization' HDORG: orcSegment.12.Repeats[0].9 -%}
                                {% include 'Resource/Organization' ORC_12: orcSegment.12.Repeats[0].9, ID: Organization_ID_ORC_12 -%}
                            {% endif -%}
                            {% evaluate practitionerId_ORC_12 using 'ID/Practitioner' XCN: orcSegment.12.Repeats[0] -%}
                            {% include 'Resource/Practitioner' ORC_med_prac: orcSegment, ID: practitionerId_ORC_12 -%}
                            {% evaluate practitionerRoleId_ORC_12 using 'ID/PractitionerRole' XCN: orcSegment.12.Repeats[0] -%}
                            {% assign full_practitionerId_ORC_12 = practitionerId_ORC_12 | prepend: 'Practitioner/' %}
                            {% include 'Resource/PractitionerRole' ORC_12: orcSegment.12.Repeats[0], ID: practitionerRoleId_ORC_12 -%}   
                            {% include 'Reference/PractitionerRole/Practitioner' REF: full_practitionerId_ORC_12, ID: practitionerRoleId_ORC_12 -%}
                            {% include 'Reference/PractitionerRole/Organization' REF: full_OrganizationId_ORC_21, ID: practitionerRoleId_ORC_12 -%}                      
                        {% elsif orcSegment.21.Repeats[0] and  rxoSegment.14.Repeats[0] == null or rxoSegment.14.Repeats[0] == "" %}    
                            {% evaluate practitionerRoleId_ORC_21 using 'ID/PractitionerRole' XCN: orcSegment.21.Repeats[0]-%}
                            {% include 'Resource/PractitionerRole' requestor_organization: organizationId_ORC_21, ID: practitionerRoleId_ORC_21 -%}
                            {% assign fullPractitionerRoleId_ORC_21 = practitionerRoleId_ORC_21 | prepend: 'PractitionerRole/' -%}
                            {% include 'Reference/PractitionerRole/Organization' REF: full_organizationId_ORC_21, ID: practitionerRoleId_ORC_21 -%}
                        {% endif %}  
    
                        {% if orcSegment.10 or orcSegment.19 %}
                            {% if orcSegment.10 %}    
                                {% if orcSegment.10.Repeats[0] -%}                    
                                    {% if orcSegment.10.Repeats[0].9.1 != "" and orcSegment.10.Repeats[0].9.1 != null and orcSegment.10.Repeats[0].9.2 != "" and orcSegment.10.Repeats[0].9.2 != null and orcSegment.10.Repeats[0].9.3 != "" and orcSegment.10.Repeats[0].9.3 != null -%}
                                        {% evaluate Organization_ID_ORC_10 using 'ID/Organization' HDORG: orcSegment.10.Repeats[0].9 -%}
                                        {% include 'Resource/Organization' ORC_10: orcSegment.10.Repeats[0].9, ID: Organization_ID_ORC_10 -%}
                                    {% endif -%}
                                    {% evaluate practitionerId_ORC_10 using 'ID/Practitioner' XCN: orcSegment.10.Repeats[0] -%}
                                    {% include 'Resource/Practitioner' ORC_10: orcSegment.10, ID: practitionerId_ORC_10 -%}
                                    {% evaluate practitionerRoleId_ORC_10 using 'ID/PractitionerRole' XCN: orcSegment.10.Repeats[0] -%}
                                    {% assign full_practitionerId_ORC_10 = practitionerId_ORC_10 | prepend: 'Practitioner/' %}
                                    {% include 'Resource/PractitionerRole' ORC_10: orcSegment.10.Repeats[0], ID: practitionerRoleId_ORC_10 -%}   
                                    {% include 'Reference/PractitionerRole/Practitioner' REF: full_practitionerId_ORC_10, ID: practitionerRoleId_ORC_10 -%}
                                {% endif -%}
                            {% elsif orcSegment.19 %}    
                                {% if orcSegment.19.Repeats[0] %}
                                    {% if orcSegment.19.Repeats[0].9.1 != "" and orcSegment.19.Repeats[0].9.1 != null and orcSegment.19.Repeats[0].9.2 != "" and orcSegment.19.Repeats[0].9.2 != null and orcSegment.19.Repeats[0].9.3 != "" and orcSegment.19.Repeats[0].9.3 != null -%}
                                        {% evaluate Organization_ID_ORC_19 using 'ID/Organization' HDORG: orcSegment.19.Repeats[0].9 -%}
                                        {% include 'Resource/Organization' ORC_19: orcSegment.19.Repeats[0].9, ID: Organization_ID_ORC_19 -%}
                                    {% endif -%}
                                    {% evaluate practitionerId_ORC_19 using 'ID/Practitioner' XCN: orcSegment.19.Repeats[0] -%}
                                    {% include 'Resource/Practitioner' ORC_19: orcSegment.19, ID: practitionerId_ORC_19 -%}
                                    {% evaluate practitionerRoleId_ORC_19 using 'ID/PractitionerRole' XCN: orcSegment.19.Repeats[0] -%}
                                    {% assign full_practitionerId_ORC_19 = practitionerId_ORC_19 | prepend: 'Practitioner/' %}
                                    {% include 'Resource/PractitionerRole' ORC_19: orcSegment.19.Repeats[0], ID: practitionerRoleId_ORC_19 -%}   
                                    {% include 'Reference/PractitionerRole/Practitioner' REF: full_practitionerId_ORC_19, ID: practitionerRoleId_ORC_19 -%} 
                                {% endif -%}
                            {% endif -%}
                        {% endif %}
                        
                        {% if rxoSegment.32 -%}
                            {% evaluate Organization_ID_RXO_32 using 'ID/Organization' CWE: rxoSegment.32 -%}
                            {% include 'Resource/Organization' RXO: rxoSegment, ID: Organization_ID_RXO_32 -%}
                        {% endif -%} 
                        {% include 'Resource/MedicationRequest' ORM_ORC_7: orcSegment_7_firstRep, ORM_RXO: rxoSegment, ID: medicationRequestID -%}
                        {% assign medicationId = null -%}
                        {% if rxoSegment.1 or rxoSegment.6 -%}
                            {% evaluate medicationId using 'ID/Medication' RXO: rxoSegment -%}
                            {% include 'Resource/Medication' RXO: rxoSegment, ID: medicationId %}
                            {% assign fullMedicationId = medicationId | prepend: 'Medication/' %}
                            {% include 'Reference/MedicationRequest/MedicationReference' ID: medicationRequestId, REF: fullMedicationId -%}
                        {% endif -%}
                    {% endif %}
                {% endif %}
                {% for orc7 in orcSegment.7.Repeats %}
                    {% unless orc7.Value == orcSegment_7_firstRep.Value %}
                        {% include 'Resource/MedicationRequest' ORM_ORC_7: orc7, ID: medicationRequestId %}
                    {% endunless -%}
                {% endfor %}
            
                {% include 'Resource/MedicationRequest' ORC: orcSegment, RXO: rxoSegment, ID: medicationRequestId %}
                {% include 'Reference/MedicationRequest/Subject' ID: medicationRequestId, REF: fullPatientId -%}
                {% assign fullEncounterid = encounterId | prepend: 'Encounter/' %}
                {% include 'Reference/MedicationRequest/Encounter' ID: medicationRequestId, REF: fullEncounterid -%}

                {% for nteSegment1 in nteSegmentLists_RXO.NTE -%}
                        {% if nteSegment1.5 -%}    
                            {% if nteSegment1.5.9.1 != "" and nteSegment1.5.9.1 != null and nteSegment1.5.9.2 != "" and nteSegment1.5.9.2 != null and nteSegment1.5.9.3 != "" and nteSegment1.5.9.3 != null -%}
                                {% evaluate Organization_ID_NTE1_5_9 using 'ID/Organization' HDORG: nteSegment1.5.9 -%}
                                {% include 'Resource/Organization' OBR_NTE: nteSegment1.5.9, ID: Organization_ID_NTE1_5_9 -%}
                            {% endif -%}     
                            {% evaluate practitioner_ID_NTE_5 using 'ID/Practitioner' XCN: nteSegment1.5 -%}
                            {% include 'Resource/Practitioner' NTE: nteSegment1.5, ID: practitioner_ID_NTE_5 -%}
                        {% endif -%} 
                        {% include 'Resource/MedicationRequest' NTE: nteSegment1, ID: medicationRequestId -%}
                    {% endfor -%}

            {% endfor -%}

           

            {% for ctdSegment in ctdSegmentLists.CTD -%}
                {% include 'Resource/Patient' CTD: ctdSegment, ID: patientId -%}
            {% endfor -%}

            {% for dg1Segment in dg1SegmentLists.DG1 -%}
                {% if dg1Segment.16.Repeats[0] %}
                    {% if dg1Segment.16.Repeats[0].9.1 != "" and dg1Segment.16.Repeats[0].9.1 != null and dg1Segment.16.Repeats[0].9.2 != "" and dg1Segment.16.Repeats[0].9.2 != null and dg1Segment.16.Repeats[0].9.3 != "" and dg1Segment.16.Repeats[0].9.3 != null -%}
                        {% evaluate Organization_ID_DG1_16 using 'ID/Organization' HDORG: dg1Segment.16.Repeats[0].9 -%}
                        {% include 'Resource/Organization', DG1: dg1Segment.16.Repeats[0].9, ID: Organization_ID_DG1_16 -%}
                    {% endif -%}
                    {% evaluate practitionerId_DG1_16 using 'ID/Practitioner' XCN: dg1Segment.16.Repeats[0] -%}
                    {% include 'Resource/Practitioner' DG1: dg1Segment, ID: practitionerId_DG1_16 -%}
                {% endif -%}
                
                {% evaluate conditionId using 'ID/Condition' DG1: dg1Segment, baseId: patientId -%}
                {% include 'Resource/Condition' DG1: dg1Segment, Condition_Subject_ID: fullPatientId, baseId: patientId, ID: conditionId -%}
                {% assign fullConditionId = conditionId | prepend: 'Condition/'  -%}

                {% if serviceRequestId -%}
                    {% include 'Reference/ServiceRequest/ReasonReference' REF: fullConditionId, ID: serviceRequestId -%}
                {% endif -%}

                {% if supplyRequestID -%}
                    {% include 'Reference/SupplyRequest/ReasonReference' REF: fullConditionId, ID: supplyRequestID -%}
                {% endif -%}

                {% if medicationRequestId -%}
                    {% include 'Reference/MedicationRequest/ReasonReference' REF: fullConditionId, ID: medicationRequestId -%}
                {% endif -%}

                {% if encounterId -%}
                    {% include 'Resource/Encounter' DG1: dg1Segment, conditionId: conditionId, ID: encounterId -%}
                {% endif %}
                {% if EpisodeOfCare_ID %}
                    {% include 'Resource/EpisodeOfCare' DG1: dg1Segment, conditionId: conditionId, ID: EpisodeOfCare_ID -%}
                {% endif %}
                {% if dg1Segment.22 -%}
                    {% evaluate conditionId_DG1_22 using 'ID/Condition' DG1: dg1Segment.22, baseId: patientId -%}
                    {% include 'Resource/Condition' DG1_22: dg1Segment.22, Condition_Subject_ID_DG1_22: fullPatientId, ID: conditionId_DG1_22 -%}
                {% endif -%}
                {% include 'Extensions/Condition/ConditionExtension' DG1: dg1Segment, ID_DG1_22:conditionId_DG1_22, ID: conditionId %}

            {% endfor -%}

            {% for obxSegment in obxSegmentLists.OBX -%}
                {% if obxSegment.2.Value == 'ED' or obxSegment.2.Value == 'RP' %}
                    {% for obx_16 in obxSegment.16.Repeats -%}
                        {% if obx_16.9.1 != "" and obx_16.9.1 != null and obx_16.9.2 != "" and obx_16.9.2 != null and obx_16.9.3 != "" and obx_16.9.3 != null -%}
                            {% evaluate Organization_ID_OBX_16 using 'ID/Organization' HDORG: obx_16.9 -%}
                            {% include 'Resource/Organization' OBX: obx_16.9, ID: Organization_ID_OBX_16 -%}
                        {% endif -%}
                        {% evaluate practitionerId_OBX_16 using 'ID/Practitioner' XCN: obx_16 -%}
                        {% include 'Resource/Practitioner' OBX: obxSegment, OBXXCN1: obx_16, ID: practitionerId_OBX_16 -%}
                        {% evaluate practitionerRoleId_OBX_16 using 'ID/PractitionerRole' XCN: obx_16 -%}
                        {% assign full_practitionerId_OBX_16 = practitionerId_OBX_16 | prepend: 'Practitioner/' %}
                        {% include 'Resource/PractitionerRole' OBXXCN1: obx_16, ID: practitionerRoleId_OBX_16 -%}   
                        {% include 'Reference/PractitionerRole/Practitioner' REF: full_practitionerId_OBX_16, ID: practitionerRoleId_OBX_16 -%}
                    {% endfor %}
                    {% if obxSegment.23 or obxSegment.25 %}
                        {% evaluate practitionerRoleId_OBX_25 using 'ID/PractitionerRole' XCN: obxSegment.25 -%}
                    {% endif %} 
                    {% if obxSegment.25 -%}
                        {% evaluate practitionerId_OBX_25 using 'ID/Practitioner' XCN: obxSegment.25 -%}
                        {% include 'Resource/Practitioner' OBX: obxSegment, OBXXCN2: obxSegment.25, ID: practitionerId_OBX_25 -%}
                        {% assign full_practitionerId_OBX_25 = practitionerId_OBX_25 | prepend: 'Practitioner/' %}
                        {% include 'Resource/PractitionerRole' OBXXCN2: obxSegment.25, ID: practitionerRoleId_OBX_25 -%}  
                        {% include 'Reference/PractitionerRole/Practitioner' REF: full_practitionerId_OBX_25, ID: practitionerRoleId_OBX_25 -%}
                    {% endif -%}
                    {% if obxSegment.23 -%}
                        {% evaluate organizationId_OBX_23 using 'ID/Organization' XON: obxSegment.23 -%}
                        {% include 'Resource/Organization' OBX_23: obxSegment.23, OBX_24: obxSegment.24, ID: organizationId_OBX_23 -%}                
                        {% if obxSegment.25 -%}
                            {% assign full_organizationId_OBX_23 = organizationId_OBX_23 | prepend: 'Organization/' %} 
                            {% include 'Reference/PractitionerRole/Organization' REF: full_organizationId_OBX_23, ID: practitionerRoleId_OBX_25 -%}     
                        {% endif -%}
                    {% endif -%}
                    {% evaluate obx_diagnosticReportID using 'ID/DiagnosticReport' OBX: obxSegment -%}   
                    {% include 'Resource/DiagnosticReport' OBX: obxSegment, ID: obx_diagnosticReportID, DiagnosticReport_Subject_ID: fullPatientId-%}   
                    {% if serviceRequestId != null -%}
                        {% assign fullServiceRequestId = serviceRequestId | prepend: 'ServiceRequest/' -%}
                        {% include 'Reference/DiagnosticReport/BasedOn' REF: fullServiceRequestId, ID: obx_diagnosticReportID -%}
                    {% endif -%}
                {% else %}
                    {% for obx_16 in obxSegment.16.Repeats -%}
                        {% if obx_16.9.1 != "" and obx_16.9.1 != null and obx_16.9.2 != "" and obx_16.9.2 != null and obx_16.9.3 != "" and obx_16.9.3 != null -%}
                            {% evaluate Organization_ID_OBX_16 using 'ID/Organization' HDORG: obx_16.9 -%}
                            {% include 'Resource/Organization' OBX: obx_16.9, ID: Organization_ID_OBX_16 -%}
                        {% endif -%}
                        {% evaluate practitionerId_OBX_16 using 'ID/Practitioner' XCN: obx_16 -%}
                        {% include 'Resource/Practitioner' OBX: obxSegment, OBXXCN1: obx_16, ID: practitionerId_OBX_16 -%}
                        {% evaluate practitionerRoleId_OBX_16 using 'ID/PractitionerRole' XCN: obx_16 -%}
                        {% assign full_practitionerId_OBX_16 = practitionerId_OBX_16 | prepend: 'Practitioner/' %}
                        {% include 'Resource/PractitionerRole' OBXXCN1: obx_16, ID: practitionerRoleId_OBX_16 -%}   
                        {% include 'Reference/PractitionerRole/Practitioner' REF: full_practitionerId_OBX_16, ID: practitionerRoleId_OBX_16 -%}
                    {% endfor %}
                    {% if obxSegment.18 -%}
                        {% evaluate deviceId_OBX_18 using 'ID/Device' EI: obxSegment.18.Repeats[0] -%}
                        {% include 'Resource/Device' EI_OBX18: obxSegment.18, ID: deviceId_OBX_18 -%}
                    {% endif -%}
                    {% if obxSegment.23 or obxSegment.25 %}
                        {% evaluate practitionerRoleId_OBX_25 using 'ID/PractitionerRole' XCN: obxSegment.25 -%}
                    {% endif %}
                    {% if obxSegment.25 -%}
                        {% evaluate practitionerId_OBX_25 using 'ID/Practitioner' XCN: obxSegment.25 -%}
                        {% include 'Resource/Practitioner' OBX: obxSegment, OBXXCN2: obxSegment.25, ID: practitionerId_OBX_25 -%}
                        {% assign full_practitionerId_OBX_25 = practitionerId_OBX_25 | prepend: 'Practitioner/' %}
                        {% include 'Resource/PractitionerRole' OBXXCN2: obxSegment.25, ID: practitionerRoleId_OBX_25 -%}  
                        {% include 'Reference/PractitionerRole/Practitioner' REF: full_practitionerId_OBX_25, ID: practitionerRoleId_OBX_25 -%}
                    {% endif -%}
                    {% if obxSegment.23 -%}
                        {% evaluate organizationId_OBX_23 using 'ID/Organization' XON: obxSegment.23 -%}
                        {% include 'Resource/Organization' OBX_23: obxSegment.23, OBX_24: obxSegment.24, ID: organizationId_OBX_23 -%}                
                        {% if obxSegment.25 -%}
                            {% assign full_organizationId_OBX_23 = organizationId_OBX_23 | prepend: 'Organization/' %} 
                            {% include 'Reference/PractitionerRole/Organization' REF: full_organizationId_OBX_23, ID: practitionerRoleId_OBX_25 -%}     
                        {% endif -%}
                    {% endif -%}
                    {% evaluate observationId using 'ID/Observation' OBX: obxSegment, baseId: patientId -%}   
                    {% include 'Resource/Observation' OBX: obxSegment, Observation_Subject_ID: fullPatientId, ID: observationId -%}
                    {% include 'Extensions/Observation/ObservationExtension' OBX: obxSegment, ID: observationId %}
                    {% if serviceRequestId != null -%}
                        {% assign fullServiceRequestId = serviceRequestId | prepend: 'ServiceRequest/' -%}
                        {% include 'Reference/Observation/BasedOn' REF: fullServiceRequestId, ID: observationId -%}
                    {% endif -%}
                    {% assign nteSegmentLists2 = hl7v2Data | get_related_segment_list: obxSegment, 'NTE' -%}
                    {% for nteSegment2 in nteSegmentLists2.NTE -%}    
                        {% if nteSegment2.5 -%}    
                            {% if nteSegment2.5.9.1 != "" and nteSegment2.5.9.1 != null and nteSegment2.5.9.2 != "" and nteSegment2.5.9.2 != null and nteSegment2.5.9.3 != "" and nteSegment2.5.9.3 != null -%}
                                {% evaluate Organization_ID_NTE2_5_9 using 'ID/Organization' HDORG: nteSegment2.5.9 -%}
                                {% include 'Resource/Organization' OBX_NTE: nteSegment2.5.9, ID: Organization_ID_NTE2_5_9 -%}
                            {% endif -%}     
                            {% evaluate practitioner_ID_NTE_5 using 'ID/Practitioner' XCN: nteSegment2.5 -%}
                            {% include 'Resource/Practitioner' NTE: nteSegment2.5, ID: practitioner_ID_NTE_5 -%}
                        {% endif -%} 
                        {% include 'Resource/Observation' NTE: nteSegment2, ID: observationId -%}
                    {% endfor -%}
                {% endif -%}
            {% endfor -%}

            {% unless supplyRequestID or NutritionOrder -%}
                {% assign cti_obrSegmentLists = hl7v2Data | get_related_segment_list: orcSegment, 'CTI' -%}

                {% for ctiSegment in cti_obrSegmentLists.CTI %}
                    {% evaluate researchStudyID using 'ID/ResearchStudy' EI: ctiSegment.1 -%}
                    {% include 'Resource/ResearchStudy' CTI: ctiSegment, ID: researchStudyID -%}
                    {% assign fullResearchStudyID = researchStudyID | prepend: 'ResearchStudy/' %}
                    {% if serviceRequestId %}
                        {% include 'Reference/ServiceRequest/SupportingInfo' ID: serviceRequestId, REF: fullResearchStudyID -%}
                    {% elsif medicationRequestId %}
                        {% include 'Reference/MedicationRequest/SupportingInformation' ID: medicationRequestId, REF: fullResearchStudyID -%}
                    {% endif %}
                    
                {% endfor %}
            {% endunless -%}

            {% assign ft1SegmentLists = hl7v2Data | get_related_segment_list: orcSegment, 'FT1' -%}
           
            {% assign blg_orcSegmentLists = hl7v2Data | get_related_segment_list: orcSegment, 'BLG' -%}
            {% assign blgSegment = blg_orcSegmentLists.BLG[0] %}
            {% assign full_accountId_BLG = null %}
            {% if blgSegment.3 %}
                {% evaluate accountId_BLG using 'ID/Account' BLG: blgSegment.3 -%}
                {% assign full_accountId_BLG = accountId_BLG | prepend: 'Account/' %}
                {% if serviceRequestId %}
                    {% include 'Reference/ServiceRequest/SupportingInfo' ID: serviceRequestId, REF: full_accountId_BLG -%}
                {% elsif medicationRequestId %}
                    {% include 'Reference/MedicationRequest/SupportingInformation' ID: medicationRequestId, REF: full_accountId_BLG -%}
                {% endif %}
                {% include 'Resource/Account' BLG: blgSegment, ID: AccountId_BLG -%}
                {% if blgSegment.3.4.1 != "" and blgSegment.3.4.1 != null and blgSegment.3.4.2 != "" and blgSegment.3.4.2 != null and blgSegment.3.4.3 != "" and blgSegment.3.4.3 != null -%}
                    {% evaluate Organization_ID_blg_CX_3 using 'ID/Organization' HDORG: blgSegment.3.4 -%}
                    {% include 'Resource/Organization', PID: blgSegment.3, ID: Organization_ID_blg_CX_3 -%}
                {% endif -%}
            {% endif %}

            {% for ft1Segment in ft1SegmentLists.FT1 -%}

                {% if ft1Segment.6.Value == 'CG' -%}           
                    {% evaluate chargeitem_id using 'ID/ChargeItem' FT1: ft1Segment, baseId: patientId -%}
                    {% include 'Resource/ChargeItem' FT1: ft1Segment, ID: chargeitem_id %}
                    {% include 'Reference/ChargeItem/Subject' REF: fullPatientId, ID: chargeitem_id -%}
                    {% assign fullAccountId = accountId | prepend: 'Account/' -%}
                    {% include 'Reference/ChargeItem/Account' REF: fullAccountId, ID: chargeitem_id -%}
                    {% if full_accountId_BLG %}
                        {% include 'Reference/ChargeItem/Account' REF: full_accountId_BLG , ID: chargeitem_id -%}
                    {% endif %}
                    {% assign firstFullencounterId = encounterId | prepend: 'Encounter/' -%}
                    {% include 'Reference/ChargeItem/Context' REF: firstFullencounterId, ID: chargeitem_id -%}    

                    {% if serviceRequestId -%}
                        {% assign fullServiceRequestId = serviceRequestId | prepend: 'ServiceRequest/' -%}
                        {% include 'Reference/ChargeItem/SupportingInformation' REF: fullServiceRequestId, ID: chargeitem_id -%}
                    {% endif -%}

                    {% if supplyRequestID -%}
                        {% assign fullSupplyRequestId = supplyRequestID | prepend: 'SupplyRequest/' -%}
                        {% include 'Reference/ChargeItem/SupportingInformation' REF: fullSupplyRequestId, ID: chargeitem_id -%}
                    {% endif -%}

                    {% if medicationRequestId -%}
                        {% assign fullMedicationRequest = medicationRequestId | prepend: 'MedicationRequest/' -%}
                        {% include 'Reference/ChargeItem/SupportingInformation' REF: fullMedicationRequest, ID: chargeitem_id -%}
                    {% endif -%}

                    {% if NutritionOrder %}
                        {% assign fullNutritionOrder = NutritionOrder | prepend: 'NutritionOrder/' -%}
                        {% include 'Reference/ChargeItem/SupportingInformation' REF: fullNutritionOrder, ID: chargeitem_id -%}
                    {% endif %}         

                    {% if ft1Segment.13 -%}
                        {% evaluate Organization_ID_FT1 using 'ID/Organization' CWE: ft1Segment.13 -%}
                        {% include 'Resource/Organization' FT1: ft1Segment, ID: Organization_ID_FT1 -%}
                        {% assign full_organizationId_FT1 = Organization_ID_FT1 | prepend: 'Organization/' %}
                        {% include 'Reference/ChargeItem/CostCenter' REF: full_organizationId_FT1, ID: chargeitem_id -%}
                    {% endif -%}

                    {% if ft1Segment.20 -%}
                        {% if ft1Segment.20.9.1 != "" and ft1Segment.20.9.1 != null and ft1Segment.20.9.2 != "" and ft1Segment.20.9.2 != null and ft1Segment.20.9.3 != "" and ft1Segment.20.9.3 != null -%}
                            {% evaluate Organization_ID_FT1_20_9 using 'ID/Organization' HDORG: ft1Segment.20.9 -%}
                            {% include 'Resource/Organization', FT1_20: ft1Segment.20.9, ID: Organization_ID_FT1_20_9 -%}
                        {% endif -%} 
                        {% evaluate Practitioner_ID_FT1_20 using 'ID/Practitioner' XCN: ft1Segment.20 -%}
                        {% include 'Resource/Practitioner' FT1: ft1Segment.20, ID: Practitioner_ID_FT1_20 -%}
                        {% assign full_Practitioner_ID_FT1_20 = Practitioner_ID_FT1_20 | prepend: 'Practitioner/' %}
                        {% include 'Reference/ChargeItem/Performer_Actor' REF: full_Practitioner_ID_FT1_20, ID: chargeitem_id -%}
                    {% endif -%}

                    {% if ft1Segment.24 -%}
                        {% if ft1Segment.24.9.1 != "" and ft1Segment.24.9.1 != null and ft1Segment.24.9.2 != "" and ft1Segment.24.9.2 != null and ft1Segment.24.9.3 != "" and ft1Segment.24.9.3 != null -%}
                            {% evaluate Organization_ID_FT1_20_9 using 'ID/Organization' HDORG: ft1Segment.24.9 -%}
                            {% include 'Resource/Organization', FT1_20: ft1Segment.24.9, ID: Organization_ID_FT1_20_9 -%}
                        {% endif -%} 
                        {% evaluate Practitioner_ID_FT1_20 using 'ID/Practitioner' XCN: ft1Segment.24 -%}
                        {% include 'Resource/Practitioner' FT1: ft1Segment.24, ID: Practitioner_ID_FT1_20 -%}
                        {% assign full_Practitioner_ID_FT1_20 = Practitioner_ID_FT1_20 | prepend: 'Practitioner/' %}
                        {% include 'Reference/ChargeItem/Enterer' REF: full_Practitioner_ID_FT1_20, ID: chargeitem_id -%}
                    {% endif -%}

                    {% if orcSegment.2 -%}
                    {% if ft1Segment.25 -%}
                        {% evaluate Procedure_ID_FT1_25 using 'ID/Procedure' FT1: ft1Segment.25, ORC_FT1: orcSegment.2, baseId: patientId -%}
                        {% include 'Resource/Procedure' FT1: ft1Segment, ID: Procedure_ID_FT1_25, Procedure_Subject_ID: fullPatientId -%}
                        {% include 'Resource/ChargeItem' procedure_ft1_25: Procedure_ID_FT1_25, ID: chargeitem_id -%}
                    {% endif -%}
                    {% endif -%}

                    {% if orcSegment.2 -%}
                    {% if ft1Segment.29 -%}
                        {% evaluate Medication_Dispense_ID_FT1_25 using 'ID/MedicationDispense' FT1: ft1Segment.29, ORC_FT1: orcSegment.2, baseId: patientId -%}
                        {% include 'Resource/MedicationDispense' FT1: ft1Segment, ID: Medication_Dispense_ID_FT1_25, subjectRefrence: patientId -%}
                        {% include 'Resource/ChargeItem' medicationdispense_ft1_29: Medication_Dispense_ID_FT1_25, ID: chargeitem_id -%}
                    {% endif -%}
                    {% endif -%}

                    {% if ft1Segment.32 -%}
                        {% evaluate Organization_ID_FT1_32 using 'ID/Organization' XON: ft1Segment.32 -%}
                        {% include 'Resource/Organization' FT1_32: ft1Segment, ID: Organization_ID_FT1_32 -%}
                        {% assign full_Practitioner_ID_FT1_32 = Organization_ID_FT1_32 | prepend: 'Organization/' %}
                        {% include 'Reference/ChargeItem/PerformingOrganization' REF: full_Practitioner_ID_FT1_32, ID: chargeitem_id -%}
                    {% endif -%}

                    {% if ft1Segment.33 -%}
                        {% evaluate Organization_ID_FT1_33 using 'ID/Organization' XON: ft1Segment.33 -%}
                        {% include 'Resource/Organization' FT1_33: ft1Segment, ID: Organization_ID_FT1_33 -%}
                        {% assign full_Practitioner_ID_FT1_33 = Organization_ID_FT1_33 | prepend: 'Organization/' %}
                        {% include 'Reference/ChargeItem/RequestingOrganization' REF: full_Practitioner_ID_FT1_33, ID: chargeitem_id -%}              
                    {% endif -%}

                    {% if ft1Segment.34 -%}
                        {% evaluate deviceId_FT1_34 using 'ID/Device' FT1: ft1Segment -%}
                        {% include 'Resource/Device' FT1: ft1Segment, ID: deviceId_FT1_34, Device_Patient_ID:fullPatientId -%}
                        {% assign full_Device_ID_FT1 = deviceId_FT1_34 | prepend: 'Device/' %}
                        {% include 'Reference/ChargeItem/ProductReference' REF: full_Device_ID_FT1, ID: chargeitem_id -%}
                    {% endif -%}
                {% endif -%}
            {% endfor %}

        {% endfor -%}
    ] 
}